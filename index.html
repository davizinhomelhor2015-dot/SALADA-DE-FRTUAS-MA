<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>SALADA DE FRUTA</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--pink:#FF2D78;--cyan:#00F5FF;--green:#39FF14;--yellow:#FFE600;--purple:#BF5FFF;--bg:#040810;--glass:rgba(0,245,255,0.04);--border:rgba(0,245,255,0.15);--text:#E0F4FF;--dim:rgba(224,244,255,0.35)}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);min-height:100%;overflow-x:hidden;-webkit-text-size-adjust:100%}
body::before{content:'';position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(0,245,255,.025)1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.025)1px,transparent 1px);background-size:40px 40px;pointer-events:none}
body::after{content:'';position:fixed;inset:0;z-index:1;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07)2px,rgba(0,0,0,.07)4px);pointer-events:none}
.orb{position:fixed;border-radius:50%;filter:blur(80px);opacity:.08;pointer-events:none;z-index:0}
.o1{width:400px;height:400px;background:var(--pink);top:-100px;left:-100px}
.o2{width:350px;height:350px;background:var(--cyan);bottom:-100px;right:-100px}
.o3{width:250px;height:250px;background:var(--purple);top:40%;left:50%;transform:translate(-50%,-50%)}
#app{position:relative;z-index:10;max-width:960px;margin:0 auto;padding:1.5rem 1rem 3rem}
.screen{display:none}.screen.active{display:block;animation:fadeUp .35s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.neon-title{font-family:'Orbitron',monospace;font-weight:900;text-align:center;letter-spacing:.06em;line-height:1;text-transform:uppercase}
.np{color:var(--pink);text-shadow:0 0 7px var(--pink),0 0 20px var(--pink),0 0 50px var(--pink)}
.nc{color:var(--cyan);text-shadow:0 0 7px var(--cyan),0 0 20px var(--cyan),0 0 50px var(--cyan)}
.ng{color:var(--green);text-shadow:0 0 7px var(--green),0 0 20px var(--green)}
.ny{color:var(--yellow);text-shadow:0 0 7px var(--yellow),0 0 20px var(--yellow)}
.panel{background:var(--glass);border:1px solid var(--border);border-radius:4px;padding:1.5rem;position:relative;overflow:hidden;margin-bottom:1rem;backdrop-filter:blur(6px)}
.panel::before,.panel::after{content:'';position:absolute;width:12px;height:12px;border-color:var(--cyan);border-style:solid}
.panel::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.panel::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}
.panel-yellow{border-color:rgba(255,230,0,.2)}.panel-yellow::before,.panel-yellow::after{border-color:var(--yellow)}
.ptag{position:absolute;top:-1px;left:16px;background:var(--cyan);color:var(--bg);font-family:'Orbitron',monospace;font-size:.55rem;font-weight:700;letter-spacing:.15em;padding:.12rem .5rem;text-transform:uppercase}
.ptag.yw{background:var(--yellow)}
/* inputs ‚Äî 16px evita zoom iOS */
.field{margin-bottom:1rem}
.field label{display:block;font-family:'Orbitron',monospace;font-size:.58rem;font-weight:700;letter-spacing:.18em;color:var(--cyan);text-transform:uppercase;margin-bottom:.4rem;opacity:.7}
.field input{width:100%;padding:.8rem .9rem;background:rgba(0,245,255,.04);border:1px solid rgba(0,245,255,.2);border-radius:2px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;caret-color:var(--cyan);-webkit-appearance:none;appearance:none}
.field input:focus{border-color:var(--cyan);background:rgba(0,245,255,.07)}
.big-code{font-family:'Orbitron',monospace!important;font-size:1.6rem!important;font-weight:900!important;text-align:center!important;letter-spacing:.5rem!important;text-transform:uppercase!important;padding:1rem!important;color:var(--yellow)!important;border-color:rgba(255,230,0,.3)!important;background:rgba(255,230,0,.03)!important;caret-color:var(--yellow)!important}
/* buttons */
.btn{display:flex;align-items:center;justify-content:center;gap:.4rem;width:100%;padding:.85rem 1.2rem;border:none;border-radius:2px;font-family:'Orbitron',monospace;font-size:.78rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:opacity .15s,transform .15s;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.btn:active:not(:disabled){transform:scale(.96);opacity:.8}
.btn:disabled{opacity:.3;pointer-events:none}
.btn-cyan{background:transparent;color:var(--cyan);border:1.5px solid var(--cyan);box-shadow:0 0 12px rgba(0,245,255,.15)}
.btn-pink{background:transparent;color:var(--pink);border:1.5px solid var(--pink);box-shadow:0 0 12px rgba(255,45,120,.15)}
.btn-green{background:transparent;color:var(--green);border:1.5px solid var(--green);box-shadow:0 0 12px rgba(57,255,20,.15)}
.btn-ghost{background:transparent;color:var(--dim);border:1px solid rgba(224,244,255,.1);font-size:.72rem}
.btn-sm{padding:.45rem .9rem;font-size:.65rem;width:auto}
.btn-icon{width:2.4rem;height:2.4rem;padding:0;border-radius:50%;font-size:1rem;flex-shrink:0;min-width:2.4rem}
.divider{display:flex;align-items:center;gap:.75rem;margin:1rem 0;color:var(--dim);font-size:.65rem;font-family:'Orbitron',monospace;letter-spacing:.2em;text-transform:uppercase}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(0,245,255,.2),transparent)}
/* code box */
.code-box{text-align:center;padding:1.25rem .75rem .5rem}
.code-box .cbl{font-family:'Orbitron',monospace;font-size:.55rem;letter-spacing:.2em;color:var(--dim);text-transform:uppercase;margin-bottom:.5rem}
.code-box .cbv{font-family:'Orbitron',monospace;font-size:2.6rem;font-weight:900;letter-spacing:.6rem;color:var(--yellow);text-shadow:0 0 10px var(--yellow),0 0 30px var(--yellow);line-height:1}
/* player list */
.plist{display:flex;flex-direction:column;gap:.4rem}
.prow{display:flex;align-items:center;gap:.75rem;padding:.65rem .9rem;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.08);border-left:2px solid rgba(0,245,255,.3);border-radius:2px}
.prow.me{background:rgba(57,255,20,.04);border-left-color:var(--green)}
.prow.host{border-left-color:var(--yellow)}
.pdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--cyan);box-shadow:0 0 5px var(--cyan)}
.pdot.me{background:var(--green);box-shadow:0 0 5px var(--green)}
.pdot.host{background:var(--yellow);box-shadow:0 0 5px var(--yellow)}
.pname{flex:1;font-weight:700;font-size:.95rem}
.ptag2{font-family:'Orbitron',monospace;font-size:.55rem;color:var(--green);letter-spacing:.08em;margin-left:.3rem}
.ptag2.ht{color:var(--yellow)}
.ppts{font-family:'Orbitron',monospace;font-size:.8rem;font-weight:700;color:var(--cyan)}
.rule-item{display:flex;align-items:center;gap:.6rem;padding:.45rem 0;font-size:.85rem;font-weight:600;color:var(--dim);border-bottom:1px solid rgba(0,245,255,.05)}
.rule-item:last-child{border-bottom:none}
.rbadge{font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;padding:.12rem .5rem;border-radius:2px;white-space:nowrap;flex-shrink:0}
.rbg{color:var(--green);border:1px solid rgba(57,255,20,.4);background:rgba(57,255,20,.06)}
.rby{color:var(--yellow);border:1px solid rgba(255,230,0,.4);background:rgba(255,230,0,.06)}
.rbp{color:var(--pink);border:1px solid rgba(255,45,120,.4);background:rgba(255,45,120,.06)}
/* lobby grid */
.lobby-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1.25rem}
/* HUD */
.hud{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
.hud-round{font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.18em;color:var(--dim);text-transform:uppercase}
.hud-round span{color:var(--cyan)}
.hud-timer{font-family:'Orbitron',monospace;font-size:3rem;font-weight:900;line-height:1;color:var(--green);text-shadow:0 0 12px var(--green);transition:color .3s;min-width:3rem;text-align:right}
.hud-timer.warn{color:var(--yellow);text-shadow:0 0 12px var(--yellow)}
.hud-timer.danger{color:var(--pink);text-shadow:0 0 12px var(--pink);animation:tPanic .6s steps(1) infinite}
@keyframes tPanic{0%{opacity:1}50%{opacity:.5}}
/* letter ring */
.letter-stage{display:flex;justify-content:center;margin-bottom:1.25rem}
.letter-ring{position:relative;width:90px;height:90px;display:flex;align-items:center;justify-content:center;border-radius:50%;border:2px solid rgba(255,45,120,.4)}
.letter-char{font-family:'Orbitron',monospace;font-size:3.8rem;font-weight:900;color:white;text-shadow:0 0 10px var(--pink),0 0 28px var(--pink);animation:lPop .4s ease;display:block;line-height:1}
@keyframes lPop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
/* stop alert */
.stop-alert{background:rgba(255,230,0,.05);border:1px solid rgba(255,230,0,.25);border-radius:2px;padding:.55rem 1rem;text-align:center;font-family:'Orbitron',monospace;font-size:.62rem;letter-spacing:.1em;color:var(--yellow);margin-bottom:1rem;text-transform:uppercase}
/* categories ‚Äî 2 col */
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.cat-label{font-family:'Orbitron',monospace;font-size:.52rem;font-weight:700;letter-spacing:.12em;color:var(--cyan);text-transform:uppercase;margin-bottom:.25rem;opacity:.6}
.cat-input{width:100%;padding:.65rem .75rem;background:rgba(0,0,0,.4);border:1px solid rgba(0,245,255,.15);border-bottom:2px solid rgba(0,245,255,.3);border-radius:2px 2px 0 0;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;caret-color:var(--cyan);-webkit-appearance:none;appearance:none}
.cat-input:focus{border-bottom-color:var(--cyan);background:rgba(0,245,255,.04)}
.cat-input:disabled{opacity:.2;pointer-events:none}
/* stop button */
.stop-stage{display:flex;justify-content:center;margin:1.5rem 0 .5rem}
.stop-btn{width:100px;height:100px;border-radius:50%;border:3px solid var(--pink);background:radial-gradient(circle at 40% 35%,rgba(255,45,120,.15),rgba(255,45,120,.04)70%);color:var(--pink);font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.15rem;line-height:1;box-shadow:0 0 20px rgba(255,45,120,.4);letter-spacing:.08em;text-transform:uppercase;touch-action:manipulation;-webkit-appearance:none;transition:transform .12s,opacity .12s}
.stop-btn .si{font-size:1.6rem;line-height:1}
.stop-btn:active:not(:disabled){transform:scale(.9)}
.stop-btn:disabled{border-color:rgba(224,244,255,.1);color:rgba(224,244,255,.1);box-shadow:none;background:transparent}
/* CHAT ‚Äî painel normal que rola com a p√°gina */
.chat-panel{background:var(--glass);border:1px solid var(--border);border-radius:4px;overflow:hidden;margin-bottom:1rem;backdrop-filter:blur(6px);position:relative}
.chat-panel::before,.chat-panel::after{content:'';position:absolute;width:12px;height:12px;border-color:var(--cyan);border-style:solid}
.chat-panel::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.chat-panel::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}
.chat-head{padding:.65rem .9rem;border-bottom:1px solid rgba(0,245,255,.08);font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.15em;color:var(--cyan);text-transform:uppercase}
.chat-msgs{overflow-y:auto;padding:.6rem;display:flex;flex-direction:column;gap:.3rem;height:180px;scrollbar-width:thin;scrollbar-color:rgba(0,245,255,.2)transparent}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:rgba(0,245,255,.2);border-radius:2px}
.chat-msg{padding:.3rem .5rem;border-radius:2px;font-size:.82rem;line-height:1.4}
.chat-msg.me{background:rgba(0,245,255,.07);border-left:2px solid var(--cyan)}
.chat-msg.them{background:rgba(255,45,120,.05);border-left:2px solid rgba(255,45,120,.4)}
.chat-msg.sys{font-size:.72rem;color:rgba(255,230,0,.55);font-style:italic;padding:.2rem .5rem}
.msg-author{font-family:'Orbitron',monospace;font-size:.5rem;font-weight:700;letter-spacing:.08em;margin-bottom:.1rem}
.msg-author.me{color:var(--cyan)}.msg-author.them{color:var(--pink)}
.msg-text{color:var(--text);font-weight:600}
.chat-inp-row{display:flex;gap:.4rem;padding:.5rem .6rem;border-top:1px solid rgba(0,245,255,.08);align-items:center}
/* font-size 16px aqui tamb√©m ‚Äî evita zoom quando foca no campo de chat */
.chat-inp-row input{flex:1;padding:.5rem .65rem;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.12);border-radius:2px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;outline:none;-webkit-appearance:none;appearance:none;caret-color:var(--cyan)}
.chat-inp-row input:focus{border-color:rgba(0,245,255,.3);background:rgba(0,245,255,.05)}
/* results */
.r-header{text-align:center;margin-bottom:1.5rem}
.r-letter-ring{display:inline-flex;align-items:center;justify-content:center;width:64px;height:64px;border-radius:50%;border:2px solid var(--pink);font-family:'Orbitron',monospace;font-size:2.4rem;font-weight:900;color:white;text-shadow:0 0 10px var(--pink),0 0 28px var(--pink);margin-bottom:.75rem}
.scoreboard{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:1.25rem}
.schip{display:flex;align-items:center;gap:.4rem;padding:.4rem .85rem;border-radius:2px;font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.06em;border:1px solid}
.sc-me{color:var(--green);border-color:rgba(57,255,20,.35);background:rgba(57,255,20,.06)}
.sc-other{color:var(--cyan);border-color:rgba(0,245,255,.2);background:rgba(0,245,255,.04)}
.cat-result{margin-bottom:1.5rem}
.cr-title{font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.18em;color:var(--cyan);text-transform:uppercase;margin-bottom:.5rem;padding-bottom:.35rem;border-bottom:1px solid rgba(0,245,255,.1)}
.ans-rows{display:flex;flex-direction:column;gap:.3rem}
.ans-row{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:2px;border-left:2px solid}
.ans-row.p10{background:rgba(57,255,20,.04);border-left-color:var(--green)}
.ans-row.p5{background:rgba(255,230,0,.04);border-left-color:var(--yellow)}
.ans-row.p0{background:rgba(255,45,120,.03);border-left-color:rgba(255,45,120,.25)}
.an-player{font-weight:700;font-size:.8rem;min-width:5rem;flex-shrink:0}
.an-player.me{color:var(--green)}.an-player.them{color:var(--dim)}
.an-word{flex:1;font-size:.92rem;font-weight:700;color:var(--text);word-break:break-word}
.an-word.empty{color:rgba(224,244,255,.15);font-style:italic;font-size:.78rem;font-weight:400}
.an-pts{font-family:'Orbitron',monospace;font-size:.72rem;font-weight:700;flex-shrink:0}
.an-pts.g{color:var(--green)}.an-pts.y{color:var(--yellow)}.an-pts.r{color:rgba(255,45,120,.4)}
/* final */
.trophy-wrap{text-align:center;font-size:4rem;line-height:1;margin-bottom:.6rem}
.winner-line{font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;text-align:center;letter-spacing:.08em;color:var(--yellow);text-shadow:0 0 12px var(--yellow);margin-bottom:1.75rem;text-transform:uppercase}
.rank-row{display:flex;align-items:center;gap:.85rem;padding:.9rem 1rem;border-radius:2px;margin-bottom:.5rem}
.rk1{background:rgba(255,230,0,.06);border:1px solid rgba(255,230,0,.3)}
.rk2{background:rgba(0,245,255,.04);border:1px solid rgba(0,245,255,.15)}
.rk3{background:rgba(191,95,255,.04);border:1px solid rgba(191,95,255,.2)}
.rkn{background:rgba(224,244,255,.02);border:1px solid rgba(224,244,255,.06)}
.rank-medal{font-size:1.4rem;flex-shrink:0}
.rank-name{flex:1;font-weight:700;font-size:.95rem}
.rank-you{font-family:'Orbitron',monospace;font-size:.5rem;color:var(--green);letter-spacing:.08em;margin-left:.35rem}
.rank-pts{font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;color:var(--yellow)}
/* overlay reconectando */
.rc-overlay{position:fixed;inset:0;background:rgba(4,8,16,.96);backdrop-filter:blur(10px);z-index:9990;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.25rem}
.rc-spinner{width:48px;height:48px;border:3px solid rgba(0,245,255,.15);border-top-color:var(--cyan);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.rc-title{font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;letter-spacing:.15em;color:var(--cyan);text-transform:uppercase}
.rc-sub{font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.18em;color:var(--dim);text-transform:uppercase}
/* toast */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%)translateY(80px);background:rgba(7,17,31,.97);backdrop-filter:blur(16px);color:var(--cyan);padding:.65rem 1.4rem;border:1px solid rgba(0,245,255,.25);border-radius:2px;font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:9999;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%)translateY(0)}
/* utils */
.gap-v{display:flex;flex-direction:column;gap:.65rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:.65rem}
.mt{margin-top:.65rem}.mt2{margin-top:1rem}.center{text-align:center}
.empty-state{text-align:center;font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.18em;color:var(--dim);padding:1.25rem;text-transform:uppercase}
@media(min-width:700px){
  .lobby-grid{gap:1.25rem}
  .hud-timer{font-size:3.5rem}
  .letter-ring{width:110px;height:110px}
  .letter-char{font-size:4.8rem}
  .stop-btn{width:115px;height:115px}
  .chat-msgs{height:260px}
}
</style>
</head>
<body>
<div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
<div id="app">

<!-- HOME -->
<div id="screen-home" class="screen active">
  <div style="padding-top:2rem;margin-bottom:2.5rem">
    <div class="neon-title" style="font-size:clamp(2rem,10vw,4rem)"><span class="np">SALADA</span></div>
    <div class="neon-title" style="font-size:clamp(1.2rem,6vw,2.4rem);margin-top:.25rem"><span class="nc">DE&nbsp;</span><span class="ng">FRUTA</span></div>
    <div style="text-align:center;margin-top:.75rem"><span style="font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.3em;color:rgba(0,245,255,.3);text-transform:uppercase">‚óà STOP ONLINE ‚óà</span></div>
  </div>
  <div style="max-width:400px;margin:0 auto">
    <div class="panel">
      <div class="ptag">Identifica√ß√£o</div>
      <div class="field" style="margin-top:.5rem;margin-bottom:0">
        <label>// Seu Apelido</label>
        <input type="text" id="inp-name" maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
      </div>
    </div>
    <div class="gap-v">
      <button class="btn btn-pink" onclick="createRoom()">‚óà Criar Nova Sala</button>
      <div class="divider">ou</div>
      <div class="panel panel-yellow">
        <div class="ptag yw">Entrar</div>
        <div class="field" style="margin-top:.5rem;margin-bottom:0">
          <label>// C√≥digo da Sala</label>
          <input type="text" id="inp-code" class="big-code" maxlength="6" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
        </div>
      </div>
      <button class="btn btn-cyan" onclick="joinRoom()">‚óà Entrar na Sala</button>
    </div>
  </div>
</div>

<!-- LOBBY -->
<div id="screen-lobby" class="screen">
  <div style="margin-bottom:1.5rem">
    <div class="neon-title nc" style="font-size:clamp(1.3rem,5vw,2.2rem)">SALA DE ESPERA</div>
    <div style="text-align:center;margin-top:.4rem"><span id="lob-count" style="font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.18em;color:var(--dim);text-transform:uppercase">Aguardando...</span></div>
  </div>
  <div class="lobby-grid">
    <div>
      <div class="panel panel-yellow">
        <div class="ptag yw">C√≥digo</div>
        <div class="code-box">
          <div class="cbl">// Compartilhe</div>
          <div class="cbv" id="lob-code">------</div>
          <button class="btn btn-ghost btn-sm" style="margin:.75rem auto 0;display:flex" onclick="copyCode()">‚óà Copiar</button>
        </div>
      </div>
      <div class="panel">
        <div class="ptag">Regras</div>
        <div style="margin-top:.6rem">
          <div class="rule-item"><span class="rbadge rbg">+10</span>Resposta √∫nica</div>
          <div class="rule-item"><span class="rbadge rby">+5</span>Repetida</div>
          <div class="rule-item" style="border:none;padding-bottom:0"><span class="rbadge rbp">0</span>Vazia ou letra errada</div>
        </div>
      </div>
    </div>
    <div>
      <div class="panel" style="margin-bottom:.75rem">
        <div class="ptag">Jogadores <span id="lob-count-n" style="color:var(--cyan)">(0)</span></div>
        <div class="plist" id="lob-players" style="margin-top:.6rem"><div class="empty-state">Aguardando...</div></div>
      </div>
      <div class="gap-v">
        <button class="btn btn-green" id="btn-start" onclick="startGame()" disabled>‚ñ∂ Iniciar</button>
        <button class="btn btn-ghost" onclick="leaveRoom()">‚Üê Sair</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="screen-game" class="screen">
  <div class="hud">
    <div style="display:flex;flex-direction:column;gap:.3rem">
      <div class="hud-round">Rodada <span id="g-round">1</span>/5</div>
      <button class="btn btn-ghost btn-sm" style="width:auto;padding:.3rem .7rem;font-size:.6rem;color:var(--pink);border-color:rgba(255,45,120,.3)" onclick="confirmLeave()">‚úï Sair</button>
    </div>
    <div class="hud-timer" id="g-timer">60</div>
  </div>
  <div class="letter-stage">
    <div class="letter-ring"><span class="letter-char" id="g-letter">A</span></div>
  </div>
  <div id="g-alert" class="stop-alert" style="display:none"></div>
  <div class="panel" style="padding:1.1rem">
    <div class="cat-grid" id="g-cats"></div>
  </div>
  <div class="stop-stage">
    <button class="stop-btn" id="stop-btn" onclick="pressStop()">
      <span class="si">‚úã</span><span>STOP</span>
    </button>
  </div>

  <!-- CHAT: painel simples, rola com a p√°gina ‚Äî sem drawer, sem FAB, sem bug -->
  <div class="chat-panel">
    <div class="chat-head">üí¨ Chat</div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-inp-row">
      <input type="text" id="chat-inp" placeholder="mensagem..." maxlength="120" autocomplete="off" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter'){event.preventDefault();sendChat()}">
      <button class="btn btn-cyan btn-icon" onclick="sendChat()">‚ñ∂</button>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div id="screen-results" class="screen">
  <div class="r-header">
    <div class="r-letter-ring" id="r-letter">A</div>
    <div class="neon-title np" style="font-size:clamp(1.1rem,4vw,1.6rem)">RODADA <span id="r-round">1</span> ‚Äî RESULTADOS</div>
  </div>
  <div class="scoreboard" id="r-board"></div>
  <div class="panel" id="r-content" style="padding:1.25rem"></div>
  <div class="mt2 center">
    <button class="btn btn-green" id="btn-next" onclick="nextRound()" style="max-width:360px;margin:0 auto .65rem">Pr√≥xima Rodada ‚Üí</button>
    <div id="r-wait" class="empty-state" style="display:none">Aguardando host...</div>
  </div>
</div>

<!-- FINAL -->
<div id="screen-final" class="screen">
  <div class="trophy-wrap">üèÜ</div>
  <div class="winner-line" id="f-winner"></div>
  <div class="panel" style="max-width:540px;margin:0 auto 1.25rem;padding:1.5rem">
    <div class="ptag yw">Ranking Final</div>
    <div id="f-ranking" style="margin-top:.65rem"></div>
  </div>
  <div class="two-col" style="max-width:420px;margin:0 auto">
    <button class="btn btn-cyan" onclick="playAgain()">‚Ü∫ Revanche</button>
    <button class="btn btn-ghost" onclick="goHome()">‚åÇ In√≠cio</button>
  </div>
</div>

</div><!-- #app -->
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAnalytics }  from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
import { getDatabase, ref, set, get, update, onValue, push, remove, goOnline, goOffline }
  from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const fbApp = initializeApp({
  apiKey:'AIzaSyBdxd54oFM3eWH1duC5BTdJzjGGRDLMq-Q',
  authDomain:'mary-cb817.firebaseapp.com',
  databaseURL:'https://mary-cb817-default-rtdb.firebaseio.com',
  projectId:'mary-cb817',
  storageBucket:'mary-cb817.firebasestorage.app',
  messagingSenderId:'887348832569',
  appId:'1:887348832569:web:c6d9c32a1a1c402b8960e8',
  measurementId:'G-86HWEH554E'
});
getAnalytics(fbApp);
const db = getDatabase(fbApp);

// PID persistente
const pid = (() => {
  let id = localStorage.getItem('sf_pid');
  if (!id) { id = 'p_'+Date.now()+'_'+Math.random().toString(36).substr(2,8); localStorage.setItem('sf_pid',id); }
  return id;
})();

const gs = {
  roomId:null, roomCode:null, isHost:false,
  name: localStorage.getItem('sf_name')||'',
  answers:{}, timerInterval:null,
  unsub:null, chatUnsub:null,
  round:-1, saved:false, calcPending:false,
};

const CATS = [
  {id:'person',label:'Nome de Pessoa'},{id:'animal',label:'Animal'},
  {id:'fruit',label:'Fruta'},{id:'city',label:'Cidade'},
  {id:'object',label:'Objeto'},{id:'profession',label:'Profiss√£o'},
  {id:'color',label:'Cor'},{id:'brand',label:'Marca'},
];

const $  = id => document.getElementById(id);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const rnd6 = () => [...Array(6)].map(()=>'ABCDEFGHJKLMNPQRSTUVWXYZ'[Math.floor(Math.random()*24)]).join('');
const rndL = () => 'ABCDEFGHIJLMNOPRSTV'[Math.floor(Math.random()*19)];

let toastTm;
const toast = msg => {
  const el=$('toast'); el.textContent=msg; el.classList.add('show');
  clearTimeout(toastTm); toastTm=setTimeout(()=>el.classList.remove('show'),3000);
};

let currentScreen = '';
const showScreen = id => {
  if (currentScreen === id) return; // j√° na tela certa, n√£o faz nada
  currentScreen = id;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  $('screen-'+id).classList.add('active');
  window.scrollTo({top:0,behavior:'instant'});
};

// sess√£o
const saveSession = () => {
  if (!gs.roomId) return;
  localStorage.setItem('sf_session', JSON.stringify({roomId:gs.roomId,roomCode:gs.roomCode,name:gs.name,isHost:gs.isHost,ts:Date.now()}));
};
const clearSession = () => localStorage.removeItem('sf_session');

// criar sala
window.createRoom = async () => {
  const name=$('inp-name').value.trim();
  if (!name){toast('// INSIRA SEU APELIDO');return;}
  const code=rnd6(), roomRef=push(ref(db,'rooms')), roomId=roomRef.key;
  gs.roomId=roomId; gs.roomCode=code; gs.name=name; gs.isHost=true;
  localStorage.setItem('sf_name',name); saveSession();
  await set(roomRef,{
    code, createdAt:Date.now(),
    players:{[pid]:{name,score:0,isHost:true,ts:Date.now()}},
    gameState:{status:'waiting',letter:null,round:0,timer:60,stopped:false,stoppedBy:null},
    answers:{_:0}, chat:{_:0},
  });
  toast('// SALA CRIADA: '+code);
  showScreen('lobby'); listenRoom(roomId);
};

// entrar
window.joinRoom = async () => {
  const name=$('inp-name').value.trim();
  const code=$('inp-code').value.trim().toUpperCase();
  if (!name){toast('// INSIRA SEU APELIDO');return;}
  if (!code){toast('// INSIRA O C√ìDIGO');return;}
  const snap=await get(ref(db,'rooms'));
  const rooms=snap.val()||{};
  let foundId=null;
  Object.keys(rooms).forEach(id=>{if(rooms[id].code===code)foundId=id;});
  if (!foundId){toast('// SALA N√ÉO ENCONTRADA');return;}
  const room=rooms[foundId];
  const alreadyIn=room.players?.[pid];
  if (!alreadyIn && Object.keys(room.players||{}).length>=6){toast('// SALA CHEIA');return;}
  if (!alreadyIn && room.gameState?.status!=='waiting'){toast('// PARTIDA EM ANDAMENTO');return;}
  gs.roomId=foundId; gs.roomCode=code; gs.name=name; gs.isHost=!!room.players?.[pid]?.isHost;
  localStorage.setItem('sf_name',name); saveSession();
  await update(ref(db,`rooms/${foundId}/players/${pid}`),{name,score:room.players?.[pid]?.score||0,isHost:gs.isHost,ts:Date.now()});
  toast('// CONECTADO'); showScreen('lobby'); listenRoom(foundId);
};

// reconex√£o
async function tryReconnect(silent=false) {
  const raw=localStorage.getItem('sf_session');
  if (!raw) return false;
  let session; try{session=JSON.parse(raw);}catch{return false;}
  if (!session?.roomId||!session?.name) return false;
  if (Date.now()-(session.ts||0)>6*3600*1000){clearSession();return false;}
  let overlay=null;
  if (!silent){
    overlay=document.createElement('div');
    overlay.className='rc-overlay';
    overlay.innerHTML='<div class="rc-spinner"></div><div class="rc-title">// Reconectando...</div><div class="rc-sub">Verificando sala</div>';
    document.body.appendChild(overlay);
  }
  try {
    goOffline(db); await new Promise(r=>setTimeout(r,200)); goOnline(db);
    const snap=await get(ref(db,`rooms/${session.roomId}`));
    const data=snap.val();
    if (!data){clearSession();overlay?.remove();return false;}
    gs.roomId=session.roomId; gs.roomCode=session.roomCode||data.code;
    gs.name=session.name; gs.isHost=!!data.players?.[pid]?.isHost;
    localStorage.setItem('sf_name',session.name); saveSession();
    await update(ref(db,`rooms/${session.roomId}/players/${pid}`),{name:session.name,score:data.players?.[pid]?.score||0,isHost:gs.isHost,ts:Date.now()});
    overlay?.remove();
    if (!silent) toast('// RECONECTADO ‚úì');
    gs.unsub?.(); gs.unsub=null; gs.chatUnsub?.(); gs.chatUnsub=null;
    gs.round=-1;
    listenRoom(session.roomId); return true;
  } catch(e){overlay?.remove();return false;}
}

// visibilitychange ‚Äî volta do WhatsApp
let wasHidden=false;
document.addEventListener('visibilitychange', async ()=>{
  if (document.hidden){wasHidden=true;}
  else if (wasHidden){
    wasHidden=false;
    try{goOffline(db);await new Promise(r=>setTimeout(r,150));goOnline(db);}catch{}
    if (gs.roomId){
      try{await update(ref(db,`rooms/${gs.roomId}/players/${pid}`),{name:gs.name,isHost:gs.isHost,ts:Date.now()});}catch{}
    } else {
      const ok=await tryReconnect(true);
      if (ok) toast('// RECONECTADO ‚úì');
    }
  }
});

// listener da sala
function listenRoom(roomId){
  gs.unsub?.(); gs.unsub=null; gs.chatUnsub?.(); gs.chatUnsub=null;
  gs.unsub=onValue(ref(db,`rooms/${roomId}`),snap=>{
    const data=snap.val(); if(!data) return;
    renderLobby(data);
    const s=data.gameState?.status;
    if      (s==='playing'){showScreen('game');   renderGame(data);}
    else if (s==='results'){showScreen('results');renderResults(data);}
    else if (s==='final')  {showScreen('final');  renderFinal(data);}
    else                   {showScreen('lobby');}
  });
  gs.chatUnsub=onValue(ref(db,`rooms/${roomId}/chat`),snap=>{
    renderChatMsgs(snap.val()||{});
  });
}

// chat
window.sendChat = async ()=>{
  const inp=$('chat-inp');
  const txt=inp.value.trim();
  if (!txt||!gs.roomId) return;
  inp.value='';
  await set(push(ref(db,`rooms/${gs.roomId}/chat`)),{pid,name:gs.name,text:txt,ts:Date.now()});
};

function renderChatMsgs(data){
  const container=$('chat-msgs'); if(!container) return;
  const entries=Object.entries(data).filter(([k])=>k!=='_').map(([,v])=>v).sort((a,b)=>(a.ts||0)-(b.ts||0));
  const atBottom=container.scrollHeight-container.scrollTop-container.clientHeight<40;
  container.innerHTML='';
  entries.forEach(v=>{
    const isMe=v.pid===pid,isSys=v.sys;
    const div=document.createElement('div');
    div.className='chat-msg '+(isSys?'sys':isMe?'me':'them');
    if (!isSys){div.innerHTML=`<div class="msg-author ${isMe?'me':'them'}">${esc(v.name)}</div><div class="msg-text">${esc(v.text)}</div>`;}
    else{div.textContent=v.text;}
    container.appendChild(div);
  });
  if (atBottom) container.scrollTop=container.scrollHeight;
}

// voice chat
let voiceActive=false, localStream=null;
const peerConns={}, iceQueue={};
const RTC_CFG={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
async function leaveVoice(){
  voiceActive=false;
  localStream?.getTracks().forEach(t=>t.stop()); localStream=null;
  Object.keys(peerConns).forEach(p=>{peerConns[p]?.close();delete peerConns[p];delete iceQueue[p];});
  if (gs.roomId){
    await remove(ref(db,`rooms/${gs.roomId}/voice/${pid}`)).catch(()=>{});
    await remove(ref(db,`rooms/${gs.roomId}/signal/${pid}`)).catch(()=>{});
  }
}

// lobby
function renderLobby(data){
  $('lob-code').textContent=data.code||'------';
  const players=data.players||{}, count=Object.keys(players).length;
  $('lob-count').textContent=count===0?'// Aguardando conex√µes...':`// ${count} jogador${count!==1?'es':''} conectado${count!==1?'s':''}`;
  $('lob-count-n').textContent=`(${count})`;
  const list=$('lob-players'); list.innerHTML='';
  if (count===0){list.innerHTML='<div class="empty-state">Aguardando...</div>';}
  else{
    Object.entries(players).forEach(([id,p])=>{
      const me=id===pid;
      const row=document.createElement('div');
      row.className='prow'+(me?' me':p.isHost?' host':'');
      row.innerHTML=`<div class="pdot ${me?'me':p.isHost?'host':''}"></div><div class="pname">${esc(p.name)}${me?'<span class="ptag2">[VOC√ä]</span>':''}${p.isHost?'<span class="ptag2 ht">[HOST]</span>':''}</div><div class="ppts">${p.score||0}</div>`;
      list.appendChild(row);
    });
  }
  gs.isHost=!!players[pid]?.isHost;
  const btn=$('btn-start');
  if (gs.isHost){
    btn.style.display='flex'; btn.disabled=count<2;
    btn.textContent=count<2?'// Aguarde mais jogadores...':`‚ñ∂ Iniciar (${count} jogadores)`;
  } else {btn.style.display='none';}
}

window.startGame = async ()=>{
  await update(ref(db,`rooms/${gs.roomId}/gameState`),{status:'playing',letter:rndL(),round:1,timer:60,stopped:false,stoppedBy:null,resultsCalc:false});
  await set(push(ref(db,`rooms/${gs.roomId}/chat`)),{sys:true,text:'// PARTIDA INICIADA! BOA SORTE.',ts:Date.now()});
};

// jogo
function renderGame(data){
  const gst=data.gameState;
  $('g-round').textContent=gst.round;
  const t=$('g-timer'); t.textContent=gst.timer;
  t.className='hud-timer'+(gst.timer<=10?' danger':gst.timer<=25?' warn':'');

  if (gst.round!==gs.round){
    gs.round=gst.round; gs.answers={}; gs.saved=false; gs.calcPending=false;
    const lc=$('g-letter'); lc.textContent=gst.letter;
    lc.style.animation='none'; requestAnimationFrame(()=>{lc.style.animation='';});
    const wrap=$('g-cats'); wrap.innerHTML='';
    CATS.forEach(cat=>{
      const div=document.createElement('div');
      div.innerHTML=`<div class="cat-label">‚óà ${cat.label}</div><input class="cat-input" type="text" id="ci-${cat.id}" autocomplete="off" autocorrect="off" spellcheck="false" inputmode="text">`;
      wrap.appendChild(div);
      document.getElementById(`ci-${cat.id}`).addEventListener('input',e=>{gs.answers[cat.id]=e.target.value;});
    });
  }

  const alertEl=$('g-alert');
  if (gst.stopped&&gst.stoppedBy){
    alertEl.textContent=`// ${(data.players?.[gst.stoppedBy]?.name||'Algu√©m').toUpperCase()} APERTOU STOP ‚Äî SALVANDO...`;
    alertEl.style.display='block';
  } else {alertEl.style.display='none';}

  CATS.forEach(c=>{const inp=$(`ci-${c.id}`);if(inp)inp.disabled=gst.stopped;});
  $('stop-btn').disabled=gst.stopped;

  if (gst.stopped&&!gs.saved){
    gs.saved=true;
    set(ref(db,`rooms/${gs.roomId}/answers/${pid}/${gst.round}`),gs.answers||{}).catch(()=>{});
  }

  gs.isHost=!!data.players?.[pid]?.isHost;

  if (gs.isHost&&!gst.stopped&&!gs.timerInterval){
    gs.timerInterval=setInterval(async()=>{
      const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
      const g=s.val();
      if (!g||g.status!=='playing'||g.stopped){clearInterval(gs.timerInterval);gs.timerInterval=null;return;}
      if (g.timer>1){
        await update(ref(db,`rooms/${gs.roomId}/gameState`),{timer:g.timer-1});
      } else {
        clearInterval(gs.timerInterval); gs.timerInterval=null;
        await update(ref(db,`rooms/${gs.roomId}/gameState`),{stopped:true,stoppedBy:null,timer:0});
        setTimeout(()=>calcResults(g.round),2500);
      }
    },1000);
  }
  if (gst.stopped&&gs.timerInterval){clearInterval(gs.timerInterval);gs.timerInterval=null;}

  // Host calcula resultados quando qualquer jogador aperta STOP (ou timer zera)
  if (gst.stopped && gs.isHost && !gs.calcPending) {
    gs.calcPending = true;
    setTimeout(()=>{ gs.calcPending=false; calcResults(gst.round); }, 2500);
  }
}

window.confirmLeave = ()=>{
  if (confirm('Sair da partida? Voc√™ ser√° removido da sala.')) leaveRoom();
};

window.pressStop = async ()=>{
  const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
  if (s.val()?.stopped) return;
  const round=s.val()?.round||1;
  gs.saved=true;
  await set(ref(db,`rooms/${gs.roomId}/answers/${pid}/${round}`),gs.answers||{});
  await update(ref(db,`rooms/${gs.roomId}/gameState`),{stopped:true,stoppedBy:pid,timer:0});
  if (gs.timerInterval){clearInterval(gs.timerInterval);gs.timerInterval=null;}
  await set(push(ref(db,`rooms/${gs.roomId}/chat`)),{sys:true,text:`// ${gs.name.toUpperCase()} APERTOU STOP!`,ts:Date.now()});
  // calcResults ser√° chamado pelo host via renderGame quando receber stopped:true
};

async function calcResults(round){
  const flagRef=ref(db,`rooms/${gs.roomId}/gameState/resultsCalc`);
  const flagSnap=await get(flagRef);
  if (flagSnap.val()===true) return;
  await set(flagRef,true);
  const snap=await get(ref(db,`rooms/${gs.roomId}`));
  const data=snap.val();
  const players=data.players||{}, answers=data.answers||{};
  const letter=data.gameState.letter, pts={};
  CATS.forEach(cat=>{
    const valid={};
    Object.keys(players).forEach(id=>{
      const ans=(answers[id]?.[round]?.[cat.id]||'').trim();
      if (ans&&ans.charAt(0).toUpperCase()===letter.toUpperCase()) valid[id]=ans.toLowerCase();
    });
    Object.keys(players).forEach(id=>{
      if (!pts[id]) pts[id]=0;
      if (valid[id]===undefined) return;
      pts[id]+=Object.keys(valid).some(o=>o!==id&&valid[o]===valid[id])?5:10;
    });
  });
  const upd={};
  Object.keys(players).forEach(id=>{upd[`players/${id}/score`]=(players[id].score||0)+(pts[id]||0);});
  upd['gameState/status']='results';
  await update(ref(db,`rooms/${gs.roomId}`),upd);
}

// resultados
function renderResults(data){
  const gst=data.gameState, players=data.players||{}, answers=data.answers||{};
  const letter=gst.letter, round=gst.round;
  $('r-round').textContent=round; $('r-letter').textContent=letter;
  const board=$('r-board'); board.innerHTML='';
  Object.entries(players).sort((a,b)=>(b[1].score||0)-(a[1].score||0)).forEach(([id,p])=>{
    const chip=document.createElement('div');
    chip.className='schip '+(id===pid?'sc-me':'sc-other');
    chip.innerHTML=`${id===pid?'[VOC√ä] ':''}${esc(p.name)}: ${p.score||0} PTS`;
    board.appendChild(chip);
  });
  const content=$('r-content'); content.innerHTML='';
  CATS.forEach(cat=>{
    const valid={};
    Object.keys(players).forEach(id=>{
      const ans=(answers[id]?.[round]?.[cat.id]||'').trim();
      if (ans&&ans.charAt(0).toUpperCase()===letter.toUpperCase()) valid[id]=ans.toLowerCase();
    });
    const sec=document.createElement('div'); sec.className='cat-result';
    sec.innerHTML=`<div class="cr-title">${cat.label}</div>`;
    const rows=document.createElement('div'); rows.className='ans-rows';
    Object.entries(players).forEach(([id,player])=>{
      const raw=(answers[id]?.[round]?.[cat.id]||'').trim();
      let rowCls='p0',ptsCls='r',ptsLabel='‚úó 0';
      if (valid[id]!==undefined){
        const rep=Object.keys(valid).some(o=>o!==id&&valid[o]===valid[id]);
        rowCls=rep?'p5':'p10'; ptsCls=rep?'y':'g'; ptsLabel=rep?'‚ñ≥ +5':'‚úì +10';
      }
      const row=document.createElement('div'); row.className=`ans-row ${rowCls}`;
      row.innerHTML=`<div class="an-player ${id===pid?'me':'them'}">${esc(player.name)}${id===pid?' [voc√™]':''}</div><div class="an-word${!raw?' empty':''}">${raw?esc(raw):'vazio'}</div><div class="an-pts ${ptsCls}">${ptsLabel}</div>`;
      rows.appendChild(row);
    });
    sec.appendChild(rows); content.appendChild(sec);
  });
  gs.isHost=!!players[pid]?.isHost;
  const nb=$('btn-next'), wm=$('r-wait');
  if (gs.isHost){
    nb.style.display='flex'; wm.style.display='none';
    nb.textContent=round>=5?'‚ñ∂ Ver Ranking Final':`‚ñ∂ Pr√≥xima Rodada (${round+1}/5)`;
  } else {nb.style.display='none'; wm.style.display='block';}
}

window.nextRound = async ()=>{
  const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
  const g=s.val(); gs.round=-1;
  if (g.round>=5){
    await update(ref(db,`rooms/${gs.roomId}/gameState`),{status:'final'});
  } else {
    const letter=rndL();
    await set(push(ref(db,`rooms/${gs.roomId}/chat`)),{sys:true,text:`// RODADA ${g.round+1} ‚Äî LETRA: ${letter}`,ts:Date.now()});
    await update(ref(db,`rooms/${gs.roomId}/gameState`),{status:'playing',letter,round:g.round+1,timer:60,stopped:false,stoppedBy:null,resultsCalc:false});
  }
};

// final
function renderFinal(data){
  const players=data.players||{};
  const sorted=Object.entries(players).map(([id,p])=>({id,...p})).sort((a,b)=>(b.score||0)-(a.score||0));
  const winner=sorted[0];
  $('f-winner').textContent=winner?.id===pid?'// PARAB√âNS ‚Äî VOC√ä VENCEU!':`// VENCEDOR: ${winner?.name||'?'}`;
  const list=$('f-ranking'); list.innerHTML='';
  const cls={0:'rk1',1:'rk2',2:'rk3'}; const medals=['ü•á','ü•à','ü•â','‚óà','‚óà','‚óà'];
  sorted.forEach((p,i)=>{
    const div=document.createElement('div'); div.className=`rank-row ${cls[i]||'rkn'}`;
    div.innerHTML=`<div class="rank-medal">${medals[i]}</div><div class="rank-name">${esc(p.name)}${p.id===pid?'<span class="rank-you">[VOC√ä]</span>':''}</div><div class="rank-pts">${p.score||0} PTS</div>`;
    list.appendChild(div);
  });
}

// misc
window.copyCode = ()=>{navigator.clipboard?.writeText(gs.roomCode||'').catch(()=>{});toast('// C√ìDIGO COPIADO: '+gs.roomCode);};

window.leaveRoom = async ()=>{
  if (gs.timerInterval){clearInterval(gs.timerInterval);gs.timerInterval=null;}
  gs.unsub?.(); gs.unsub=null; gs.chatUnsub?.(); gs.chatUnsub=null;
  await leaveVoice().catch(()=>{});
  if (gs.roomId) await remove(ref(db,`rooms/${gs.roomId}/players/${pid}`)).catch(()=>{});
  gs.roomId=null; gs.roomCode=null; clearSession(); gs.round=-1;
  showScreen('home');
};

window.playAgain = async ()=>{
  const snap=await get(ref(db,`rooms/${gs.roomId}`));
  const data=snap.val(); const upd={};
  Object.keys(data.players||{}).forEach(id=>{upd[`players/${id}/score`]=0;});
  upd['gameState']={status:'waiting',letter:null,round:0,timer:60,stopped:false,stoppedBy:null};
  upd['answers']={_:0}; upd['chat']={_:0};
  await update(ref(db,`rooms/${gs.roomId}`),upd);
  gs.round=-1; showScreen('lobby');
};

window.goHome = ()=>leaveRoom();

// init
if (gs.name) $('inp-name').value=gs.name;
tryReconnect(false).then(ok=>{if(!ok)showScreen('home');});
</script>
</body>
</html>
