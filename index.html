<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SALADA DE FRUTA</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --pink:#FF2D78;--cyan:#00F5FF;--green:#39FF14;
  --yellow:#FFE600;--purple:#BF5FFF;
  --bg:#040810;--glass:rgba(0,245,255,0.04);
  --border:rgba(0,245,255,0.15);--text:#E0F4FF;
  --dim:rgba(224,244,255,0.35);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;cursor:crosshair}

body::before{content:'';position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(0,245,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.025) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none}
body::after{content:'';position:fixed;inset:0;z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px);
  pointer-events:none}

.orb{position:fixed;border-radius:50%;filter:blur(120px);opacity:.1;pointer-events:none;z-index:0;animation:orbF 18s ease-in-out infinite alternate}
.o1{width:600px;height:600px;background:var(--pink);top:-200px;left:-200px}
.o2{width:500px;height:500px;background:var(--cyan);bottom:-150px;right:-150px;animation-delay:-6s}
.o3{width:350px;height:350px;background:var(--purple);top:45%;left:50%;animation:orbF3 18s ease-in-out infinite alternate;animation-delay:-12s}
@keyframes orbF{from{transform:translate(0,0)}to{transform:translate(30px,40px)}}
@keyframes orbF3{from{transform:translate(-50%,-50%)scale(1)}to{transform:translate(calc(-50% + 30px),calc(-50% + 40px))scale(1.1)}}

#app{position:relative;z-index:10;max-width:1040px;margin:0 auto;padding:2rem 1.5rem;min-height:100vh}

/* SCREENS */
.screen{display:none}
.screen.active{display:block;animation:fadeUp .4s cubic-bezier(.22,1,.36,1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* NEON TEXT */
.neon-title{font-family:'Orbitron',monospace;font-weight:900;text-align:center;letter-spacing:.08em;line-height:1;text-transform:uppercase}
.np{color:var(--pink);text-shadow:0 0 7px var(--pink),0 0 20px var(--pink),0 0 50px var(--pink),0 0 100px rgba(255,45,120,.4)}
.nc{color:var(--cyan);text-shadow:0 0 7px var(--cyan),0 0 20px var(--cyan),0 0 50px var(--cyan),0 0 100px rgba(0,245,255,.4)}
.ng{color:var(--green);text-shadow:0 0 7px var(--green),0 0 20px var(--green),0 0 50px var(--green)}
.ny{color:var(--yellow);text-shadow:0 0 7px var(--yellow),0 0 20px var(--yellow),0 0 50px rgba(255,230,0,.5)}

/* PANEL */
.panel{background:var(--glass);border:1px solid var(--border);border-radius:4px;padding:1.75rem;position:relative;overflow:hidden;margin-bottom:1.25rem;backdrop-filter:blur(8px)}
.panel::before,.panel::after{content:'';position:absolute;width:14px;height:14px;border-color:var(--cyan);border-style:solid}
.panel::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.panel::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}
.panel-pink{border-color:rgba(255,45,120,.2)}.panel-pink::before,.panel-pink::after{border-color:var(--pink)}
.panel-yellow{border-color:rgba(255,230,0,.2)}.panel-yellow::before,.panel-yellow::after{border-color:var(--yellow)}
.panel-green{border-color:rgba(57,255,20,.15)}.panel-green::before,.panel-green::after{border-color:var(--green)}
.ptag{position:absolute;top:-1px;left:20px;background:var(--cyan);color:var(--bg);font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.15em;padding:.15rem .6rem;text-transform:uppercase}
.ptag.pk{background:var(--pink)}.ptag.yw{background:var(--yellow)}.ptag.gn{background:var(--green)}

/* INPUTS */
.field{margin-bottom:1.1rem}
.field label{display:block;font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.2em;color:var(--cyan);text-transform:uppercase;margin-bottom:.5rem;opacity:.7}
.field input{width:100%;padding:.85rem 1rem;background:rgba(0,245,255,.04);border:1px solid rgba(0,245,255,.2);border-radius:2px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:1.05rem;font-weight:600;outline:none;transition:all .2s;caret-color:var(--cyan)}
.field input::placeholder{color:rgba(224,244,255,.15)}
.field input:focus{border-color:var(--cyan);background:rgba(0,245,255,.07);box-shadow:0 0 0 3px rgba(0,245,255,.08)}
.field input:disabled{opacity:.3;cursor:not-allowed}
.big-code{font-family:'Orbitron',monospace!important;font-size:2rem!important;font-weight:900!important;text-align:center!important;letter-spacing:.6rem!important;text-transform:uppercase!important;padding:1.1rem!important;color:var(--yellow)!important;border-color:rgba(255,230,0,.3)!important;background:rgba(255,230,0,.03)!important;caret-color:var(--yellow)!important}
.big-code:focus{border-color:var(--yellow)!important;box-shadow:0 0 0 3px rgba(255,230,0,.08)!important}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:.5rem;width:100%;padding:.9rem 1.5rem;border:none;border-radius:2px;font-family:'Orbitron',monospace;font-size:.82rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:crosshair;transition:all .15s;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.07),transparent);transition:left .4s}
.btn:hover::before{left:100%}
.btn:active:not(:disabled){transform:scale(.97)}
.btn:disabled{opacity:.3;cursor:not-allowed}
.btn-cyan{background:transparent;color:var(--cyan);border:1.5px solid var(--cyan);box-shadow:0 0 12px rgba(0,245,255,.2),inset 0 0 12px rgba(0,245,255,.03)}
.btn-cyan:hover:not(:disabled){background:rgba(0,245,255,.08);box-shadow:0 0 25px rgba(0,245,255,.4);color:#fff;text-shadow:0 0 8px var(--cyan)}
.btn-pink{background:transparent;color:var(--pink);border:1.5px solid var(--pink);box-shadow:0 0 12px rgba(255,45,120,.2),inset 0 0 12px rgba(255,45,120,.03)}
.btn-pink:hover:not(:disabled){background:rgba(255,45,120,.08);box-shadow:0 0 25px rgba(255,45,120,.4);color:#fff;text-shadow:0 0 8px var(--pink)}
.btn-green{background:transparent;color:var(--green);border:1.5px solid var(--green);box-shadow:0 0 12px rgba(57,255,20,.2),inset 0 0 12px rgba(57,255,20,.03)}
.btn-green:hover:not(:disabled){background:rgba(57,255,20,.08);box-shadow:0 0 25px rgba(57,255,20,.4);color:#fff;text-shadow:0 0 8px var(--green)}
.btn-ghost{background:transparent;color:var(--dim);border:1px solid rgba(224,244,255,.1);font-size:.75rem}
.btn-ghost:hover:not(:disabled){color:var(--text);border-color:rgba(224,244,255,.25)}
.btn-sm{padding:.5rem 1rem;font-size:.7rem;width:auto}
.btn-icon{width:2.5rem;height:2.5rem;padding:0;border-radius:50%;font-size:1.1rem;flex-shrink:0}

/* DIVIDER */
.divider{display:flex;align-items:center;gap:1rem;margin:1.25rem 0;color:var(--dim);font-size:.7rem;font-weight:700;font-family:'Orbitron',monospace;letter-spacing:.2em;text-transform:uppercase}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(0,245,255,.2),transparent)}

/* CODE DISPLAY */
.code-box{text-align:center;padding:1.5rem 1rem;margin-bottom:1.25rem}
.code-box .cbl{font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.25em;color:var(--dim);text-transform:uppercase;margin-bottom:.6rem}
.code-box .cbv{font-family:'Orbitron',monospace;font-size:3.2rem;font-weight:900;letter-spacing:.8rem;color:var(--yellow);text-shadow:0 0 10px var(--yellow),0 0 30px var(--yellow),0 0 80px rgba(255,230,0,.5);line-height:1;animation:flicker 8s linear infinite}
@keyframes flicker{0%,19%,21%,23%,100%{opacity:1}20%,22%{opacity:.85}}

/* PLAYERS */
.plist{display:flex;flex-direction:column;gap:.5rem}
.prow{display:flex;align-items:center;gap:.9rem;padding:.75rem 1rem;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.08);border-left:2px solid rgba(0,245,255,.3);border-radius:2px;transition:all .2s;animation:rowSlide .35s ease both}
.prow.me{background:rgba(57,255,20,.04);border-color:rgba(57,255,20,.1);border-left-color:var(--green)}
.prow.host{border-left-color:var(--yellow)}
@keyframes rowSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.pdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:var(--cyan);box-shadow:0 0 6px var(--cyan);animation:dotP 2s ease-in-out infinite}
.pdot.me{background:var(--green);box-shadow:0 0 6px var(--green)}
.pdot.host{background:var(--yellow);box-shadow:0 0 6px var(--yellow)}
@keyframes dotP{0%,100%{opacity:1}50%{opacity:.4}}
.pname{flex:1;font-weight:700;font-size:1rem;color:var(--text)}
.ptag2{font-family:'Orbitron',monospace;font-size:.6rem;color:var(--green);letter-spacing:.1em;margin-left:.4rem}
.ptag2.ht{color:var(--yellow)}
.ppts{font-family:'Orbitron',monospace;font-size:.85rem;font-weight:700;color:var(--cyan);letter-spacing:.05em}

/* RULES */
.rule-item{display:flex;align-items:center;gap:.75rem;padding:.5rem 0;font-size:.9rem;font-weight:600;color:var(--dim);border-bottom:1px solid rgba(0,245,255,.05)}
.rule-item:last-child{border-bottom:none}
.rbadge{font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;padding:.15rem .6rem;border-radius:2px;white-space:nowrap;flex-shrink:0}
.rbg{color:var(--green);border:1px solid rgba(57,255,20,.4);background:rgba(57,255,20,.06)}
.rby{color:var(--yellow);border:1px solid rgba(255,230,0,.4);background:rgba(255,230,0,.06)}
.rbp{color:var(--pink);border:1px solid rgba(255,45,120,.4);background:rgba(255,45,120,.06)}

/* LAYOUT GRIDS */
.lobby-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;margin-top:1.5rem}
.game-layout{display:grid;grid-template-columns:1fr 320px;gap:1.25rem;align-items:start}

/* HUD */
.hud{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem}
.hud-round{font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.2em;color:var(--dim);text-transform:uppercase}
.hud-round span{color:var(--cyan)}
.hud-timer{font-family:'Orbitron',monospace;font-size:3.5rem;font-weight:900;line-height:1;letter-spacing:.05em;color:var(--green);text-shadow:0 0 15px var(--green),0 0 40px rgba(57,255,20,.4);transition:color .3s,text-shadow .3s;min-width:4.5rem;text-align:right}
.hud-timer.warn{color:var(--yellow);text-shadow:0 0 15px var(--yellow),0 0 40px rgba(255,230,0,.5)}
.hud-timer.danger{color:var(--pink);text-shadow:0 0 15px var(--pink),0 0 40px rgba(255,45,120,.6);animation:tPanic .6s steps(1) infinite}
@keyframes tPanic{0%{opacity:1}50%{opacity:.6}}

/* LETTER RING */
.letter-stage{display:flex;justify-content:center;align-items:center;margin-bottom:1.75rem}
.letter-ring{position:relative;width:120px;height:120px;display:flex;align-items:center;justify-content:center}
.letter-ring::before{content:'';position:absolute;inset:0;border-radius:50%;border:2px solid transparent;background:conic-gradient(var(--pink),var(--cyan),var(--green),var(--yellow),var(--pink)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;animation:ringR 4s linear infinite}
@keyframes ringR{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.letter-char{font-family:'Orbitron',monospace;font-size:5rem;font-weight:900;color:white;text-shadow:0 0 10px var(--pink),0 0 30px var(--pink),0 0 80px rgba(255,45,120,.6);animation:lPop .4s cubic-bezier(.34,1.56,.64,1);display:block;line-height:1}
@keyframes lPop{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}

/* STOP ALERT */
.stop-alert{background:rgba(255,230,0,.05);border:1px solid rgba(255,230,0,.25);border-radius:2px;padding:.65rem 1.2rem;text-align:center;font-family:'Orbitron',monospace;font-size:.7rem;letter-spacing:.15em;color:var(--yellow);text-shadow:0 0 10px var(--yellow);margin-bottom:1.25rem;text-transform:uppercase;animation:aGlow 1.5s ease-in-out infinite}
@keyframes aGlow{0%,100%{opacity:.8}50%{opacity:1}}

/* CATEGORY GRID */
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.cat-item{position:relative}
.cat-label{font-family:'Orbitron',monospace;font-size:.55rem;font-weight:700;letter-spacing:.18em;color:var(--cyan);text-transform:uppercase;margin-bottom:.3rem;opacity:.6;display:flex;align-items:center;gap:.4rem}
.cat-input{width:100%;padding:.75rem .9rem;background:rgba(0,0,0,.4);border:1px solid rgba(0,245,255,.15);border-bottom:2px solid rgba(0,245,255,.3);border-radius:2px 2px 0 0;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:600;outline:none;transition:all .2s;caret-color:var(--cyan)}
.cat-input::placeholder{color:rgba(224,244,255,.1)}
.cat-input:focus{border-color:rgba(0,245,255,.35);border-bottom-color:var(--cyan);background:rgba(0,245,255,.04)}
.cat-input:disabled{opacity:.25;cursor:not-allowed}
/* Validation indicator */
.val-status{height:3px;border-radius:0 0 2px 2px;transition:background .4s;background:rgba(255,255,255,.05)}
.val-status.valid{background:var(--green);box-shadow:0 0 8px var(--green)}
.val-status.invalid{background:var(--pink);box-shadow:0 0 8px var(--pink)}
.val-status.checking{background:var(--yellow);animation:checkAnim 1s ease-in-out infinite}
@keyframes checkAnim{0%,100%{opacity:.5}50%{opacity:1}}
.val-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-left:.3rem;vertical-align:middle;opacity:0;transition:opacity .3s}
.val-dot.show{opacity:1}
.val-dot.valid{background:var(--green);box-shadow:0 0 5px var(--green)}
.val-dot.invalid{background:var(--pink);box-shadow:0 0 5px var(--pink)}
.val-dot.checking{background:var(--yellow);box-shadow:0 0 5px var(--yellow);animation:dotP 1s infinite}

/* STOP BUTTON */
.stop-stage{display:flex;justify-content:center;margin-top:2rem}
.stop-btn{width:120px;height:120px;border-radius:50%;border:3px solid var(--pink);background:radial-gradient(circle at 40% 35%,rgba(255,45,120,.18),rgba(255,45,120,.05) 70%);color:var(--pink);font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;cursor:crosshair;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.2rem;line-height:1;box-shadow:0 0 20px rgba(255,45,120,.4),0 0 60px rgba(255,45,120,.2),inset 0 0 20px rgba(255,45,120,.05);transition:all .15s;animation:sGlow 2s ease-in-out infinite;position:relative;overflow:hidden;letter-spacing:.1em;text-transform:uppercase}
.stop-btn::before{content:'';position:absolute;inset:6px;border-radius:50%;border:1px solid rgba(255,45,120,.3)}
.stop-btn .si{font-size:1.8rem;line-height:1}
.stop-btn:hover:not(:disabled){background:radial-gradient(circle at 40% 35%,rgba(255,45,120,.28),rgba(255,45,120,.08) 70%);box-shadow:0 0 35px rgba(255,45,120,.7),0 0 90px rgba(255,45,120,.35),inset 0 0 30px rgba(255,45,120,.1);transform:scale(1.06)}
.stop-btn:active:not(:disabled){transform:scale(.94)}
.stop-btn:disabled{border-color:rgba(224,244,255,.1);color:rgba(224,244,255,.15);box-shadow:none;animation:none;cursor:not-allowed;background:transparent}
@keyframes sGlow{0%,100%{box-shadow:0 0 20px rgba(255,45,120,.4),0 0 60px rgba(255,45,120,.2),inset 0 0 20px rgba(255,45,120,.05)}50%{box-shadow:0 0 35px rgba(255,45,120,.7),0 0 90px rgba(255,45,120,.35),inset 0 0 30px rgba(255,45,120,.1)}}

/* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
.chat-panel{display:flex;flex-direction:column;height:100%;min-height:480px}
.chat-tabs{display:flex;gap:0;margin-bottom:0;border-bottom:1px solid rgba(0,245,255,.1)}
.chat-tab{flex:1;padding:.55rem .5rem;font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;background:transparent;border:none;color:var(--dim);transition:all .2s;text-align:center}
.chat-tab.active{color:var(--cyan);border-bottom:2px solid var(--cyan);text-shadow:0 0 8px var(--cyan)}
.chat-tab:hover:not(.active){color:var(--text)}

.chat-msgs{flex:1;overflow-y:auto;padding:.75rem;display:flex;flex-direction:column;gap:.4rem;min-height:300px;max-height:340px;scrollbar-width:thin;scrollbar-color:rgba(0,245,255,.2) transparent}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-track{background:transparent}
.chat-msgs::-webkit-scrollbar-thumb{background:rgba(0,245,255,.2);border-radius:2px}

.chat-msg{padding:.4rem .65rem;border-radius:2px;font-size:.88rem;animation:msgIn .25s ease;line-height:1.4}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.me{background:rgba(0,245,255,.07);border-left:2px solid var(--cyan);align-self:flex-end}
.chat-msg.them{background:rgba(255,45,120,.05);border-left:2px solid rgba(255,45,120,.4)}
.chat-msg.sys{background:rgba(255,230,0,.04);border-left:2px solid rgba(255,230,0,.3);font-size:.78rem;color:rgba(255,230,0,.6);font-style:italic}
.msg-author{font-family:'Orbitron',monospace;font-size:.55rem;font-weight:700;letter-spacing:.1em;margin-bottom:.2rem}
.msg-author.me{color:var(--cyan)}
.msg-author.them{color:var(--pink)}
.msg-text{color:var(--text);font-weight:600}

.chat-input-row{display:flex;gap:.5rem;padding:.75rem .75rem .75rem;border-top:1px solid rgba(0,245,255,.08);align-items:center}
.chat-input-row input{flex:1;padding:.55rem .75rem;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.12);border-radius:2px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.9rem;font-weight:600;outline:none;transition:all .2s;caret-color:var(--cyan)}
.chat-input-row input::placeholder{color:rgba(224,244,255,.12)}
.chat-input-row input:focus{border-color:rgba(0,245,255,.3);background:rgba(0,245,255,.05)}

/* Voice section */
.voice-section{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.25rem;padding:1.5rem}
.voice-status{font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:.2em;text-transform:uppercase;text-align:center;color:var(--dim)}
.voice-status.listening{color:var(--pink);text-shadow:0 0 10px var(--pink);animation:aGlow 1s infinite}
.voice-status.speaking{color:var(--green);text-shadow:0 0 10px var(--green)}

.mic-btn{width:80px;height:80px;border-radius:50%;border:2px solid var(--pink);background:radial-gradient(circle at 40% 35%,rgba(255,45,120,.15),rgba(255,45,120,.03) 70%);color:var(--pink);font-size:2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 0 15px rgba(255,45,120,.25)}
.mic-btn.active{background:radial-gradient(circle at 40% 35%,rgba(255,45,120,.3),rgba(255,45,120,.08) 70%);box-shadow:0 0 30px rgba(255,45,120,.6),0 0 60px rgba(255,45,120,.3);animation:sGlow 1s infinite}
.mic-btn:hover{transform:scale(1.08)}
.voice-transcript{font-size:.85rem;color:var(--dim);text-align:center;font-style:italic;min-height:1.5rem;padding:0 1rem}

.voice-msgs{flex:1;overflow-y:auto;padding:.75rem;display:flex;flex-direction:column;gap:.4rem;width:100%;min-height:200px;max-height:220px;scrollbar-width:thin;scrollbar-color:rgba(255,45,120,.2) transparent}

/* RESULTS */
.r-header{text-align:center;margin-bottom:2rem}
.r-letter-ring{display:inline-flex;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;border:2px solid var(--pink);font-family:'Orbitron',monospace;font-size:3rem;font-weight:900;color:white;text-shadow:0 0 10px var(--pink),0 0 30px var(--pink);box-shadow:0 0 20px rgba(255,45,120,.3),inset 0 0 20px rgba(255,45,120,.05);margin-bottom:1rem}
.scoreboard{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center;margin-bottom:1.5rem}
.schip{display:flex;align-items:center;gap:.5rem;padding:.45rem 1rem;border-radius:2px;font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.08em;border:1px solid}
.sc-me{color:var(--green);border-color:rgba(57,255,20,.35);background:rgba(57,255,20,.06)}
.sc-other{color:var(--cyan);border-color:rgba(0,245,255,.2);background:rgba(0,245,255,.04)}
.cat-result{margin-bottom:1.75rem}
.cr-title{font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.2em;color:var(--cyan);text-transform:uppercase;margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid rgba(0,245,255,.1)}
.ans-rows{display:flex;flex-direction:column;gap:.4rem}
.ans-row{display:flex;align-items:center;gap:.75rem;padding:.6rem .9rem;border-radius:2px;border-left:2px solid}
.ans-row.p10{background:rgba(57,255,20,.04);border-left-color:var(--green)}
.ans-row.p5{background:rgba(255,230,0,.04);border-left-color:var(--yellow)}
.ans-row.p0{background:rgba(255,45,120,.03);border-left-color:rgba(255,45,120,.3)}
.an-player{font-weight:700;font-size:.88rem;min-width:7rem;flex-shrink:0}
.an-player.me{color:var(--green)}.an-player.them{color:var(--dim)}
.an-word{flex:1;font-size:1rem;font-weight:700;color:var(--text)}
.an-word.empty{color:rgba(224,244,255,.15);font-style:italic;font-size:.85rem;font-weight:400}
.an-pts{font-family:'Orbitron',monospace;font-size:.8rem;font-weight:700;flex-shrink:0}
.an-pts.g{color:var(--green);text-shadow:0 0 8px var(--green)}
.an-pts.y{color:var(--yellow);text-shadow:0 0 8px var(--yellow)}
.an-pts.r{color:rgba(255,45,120,.5)}
/* Validation badge on results */
.an-vbadge{font-family:'Orbitron',monospace;font-size:.55rem;padding:.1rem .4rem;border-radius:2px;flex-shrink:0}
.an-vbadge.ok{color:var(--green);border:1px solid rgba(57,255,20,.4)}
.an-vbadge.no{color:var(--pink);border:1px solid rgba(255,45,120,.3)}

/* FINAL */
.trophy-wrap{text-align:center;font-size:5rem;line-height:1;animation:tDrop .6s cubic-bezier(.34,1.56,.64,1);filter:drop-shadow(0 0 20px rgba(255,230,0,.8));margin-bottom:.75rem}
@keyframes tDrop{from{transform:translateY(-40px)scale(.5);opacity:0}to{transform:translateY(0)scale(1);opacity:1}}
.winner-line{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;text-align:center;letter-spacing:.1em;color:var(--yellow);text-shadow:0 0 15px var(--yellow),0 0 40px rgba(255,230,0,.4);margin-bottom:2rem;text-transform:uppercase}
.rank-row{display:flex;align-items:center;gap:1rem;padding:1rem 1.2rem;border-radius:2px;animation:rowSlide .4s ease both}
.rk1{background:rgba(255,230,0,.06);border:1px solid rgba(255,230,0,.3)}
.rk2{background:rgba(0,245,255,.04);border:1px solid rgba(0,245,255,.15)}
.rk3{background:rgba(191,95,255,.04);border:1px solid rgba(191,95,255,.2)}
.rkn{background:rgba(224,244,255,.02);border:1px solid rgba(224,244,255,.06)}
.rank-medal{font-size:1.6rem;flex-shrink:0}
.rank-name{flex:1;font-weight:700;font-size:1rem;color:var(--text)}
.rank-you{font-family:'Orbitron',monospace;font-size:.55rem;color:var(--green);letter-spacing:.1em;margin-left:.4rem}
.rank-pts{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;color:var(--yellow);text-shadow:0 0 10px var(--yellow)}

/* TOAST */
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(80px);background:rgba(7,17,31,.97);backdrop-filter:blur(16px);color:var(--cyan);padding:.75rem 1.6rem;border:1px solid rgba(0,245,255,.25);border-radius:2px;font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;box-shadow:0 0 20px rgba(0,245,255,.15),0 8px 30px rgba(0,0,0,.5);z-index:9999;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}

/* UTILS */
.gap-v{display:flex;flex-direction:column;gap:.75rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.mt{margin-top:.75rem}.mt2{margin-top:1.25rem}.center{text-align:center}
.empty-state{text-align:center;font-family:'Orbitron',monospace;font-size:.65rem;letter-spacing:.2em;color:var(--dim);padding:1.5rem;text-transform:uppercase;animation:dotP 2s ease-in-out infinite}

@media(max-width:760px){
  .lobby-grid,.game-layout{grid-template-columns:1fr}
  .cat-grid{grid-template-columns:1fr}
  .two-col{grid-template-columns:1fr}
  .hud-timer{font-size:2.8rem}
  .letter-char{font-size:4rem}
  .letter-ring{width:95px;height:95px}
  .stop-btn{width:105px;height:105px;font-size:1.1rem}
}
</style>
</head>
<body>
<div class="orb o1"></div>
<div class="orb o2"></div>
<div class="orb o3"></div>
<div id="app">

<!-- ‚ñà‚ñà HOME ‚ñà‚ñà -->
<div id="screen-home" class="screen active">
  <div style="padding-top:2.5rem;margin-bottom:3rem;">
    <div class="neon-title" style="font-size:clamp(2.2rem,8vw,4.5rem);">
      <span class="np">SALADA</span>
    </div>
    <div class="neon-title" style="font-size:clamp(1.4rem,5vw,2.8rem);margin-top:.3rem;">
      <span class="nc">DE&nbsp;</span><span class="ng">FRUTA</span>
    </div>
    <div style="text-align:center;margin-top:.9rem;">
      <span style="font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.35em;color:rgba(0,245,255,.3);text-transform:uppercase;">
        ‚óà &nbsp; STOP ONLINE &nbsp; ‚óà
      </span>
    </div>
  </div>
  <div style="max-width:420px;margin:0 auto;">
    <div class="panel">
      <div class="ptag">Identifica√ß√£o</div>
      <div class="field" style="margin-top:.5rem;margin-bottom:0;">
        <label>// Seu Apelido</label>
        <input type="text" id="inp-name" maxlength="20" autocomplete="off">
      </div>
    </div>
    <div class="gap-v">
      <button class="btn btn-pink" onclick="createRoom()">‚óà Criar Nova Sala</button>
      <div class="divider">ou</div>
      <div class="panel panel-yellow">
        <div class="ptag yw">Entrar</div>
        <div class="field" style="margin-top:.5rem;margin-bottom:0;">
          <label>// C√≥digo da Sala</label>
          <input type="text" id="inp-code" class="big-code" maxlength="6" autocomplete="off">
        </div>
      </div>
      <button class="btn btn-cyan" onclick="joinRoom()">‚óà Entrar na Sala</button>
    </div>
  </div>
</div>

<!-- ‚ñà‚ñà LOBBY ‚ñà‚ñà -->
<div id="screen-lobby" class="screen">
  <div style="margin-bottom:2rem;">
    <div class="neon-title nc" style="font-size:clamp(1.5rem,5vw,2.5rem);">SALA DE ESPERA</div>
    <div style="text-align:center;margin-top:.5rem;">
      <span id="lob-count" style="font-family:'Orbitron',monospace;font-size:.6rem;letter-spacing:.2em;color:var(--dim);text-transform:uppercase;">Aguardando...</span>
    </div>
  </div>
  <div class="lobby-grid">
    <div>
      <div class="panel panel-yellow">
        <div class="ptag yw">C√≥digo</div>
        <div class="code-box" style="margin:.5rem 0 0;">
          <div class="cbl">// Compartilhe o c√≥digo</div>
          <div class="cbv" id="lob-code">------</div>
          <button class="btn btn-ghost btn-sm" style="margin:.9rem auto 0;display:flex;" onclick="copyCode()">‚óà Copiar</button>
        </div>
      </div>
      <div class="panel">
        <div class="ptag">Regras</div>
        <div style="margin-top:.75rem;">
          <div class="rule-item"><span class="rbadge rbg">+10 PTS</span>Resposta √∫nica e v√°lida</div>
          <div class="rule-item"><span class="rbadge rby">+5 PTS</span>Repetida por outro jogador</div>
          <div class="rule-item"><span class="rbadge rbp">0 PTS</span>Vazia ou letra errada</div>
          <div class="rule-item" style="border:none;padding-bottom:0;"><span style="color:var(--cyan)">‚óà</span>Preencha com a letra sorteada</div>
        </div>
      </div>
    </div>
    <div>
      <div class="panel" style="margin-bottom:1rem;">
        <div class="ptag">Jogadores <span id="lob-count-n" style="color:var(--cyan)">(0)</span></div>
        <div class="plist" id="lob-players" style="margin-top:.75rem;">
          <div class="empty-state">Aguardando conex√µes...</div>
        </div>
      </div>
      <div class="gap-v">
        <button class="btn btn-green" id="btn-start" onclick="startGame()" disabled>‚ñ∂ Iniciar Partida</button>
        <button class="btn btn-ghost" onclick="leaveRoom()">‚Üê Desconectar</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ñà‚ñà GAME ‚ñà‚ñà -->
<div id="screen-game" class="screen">
  <div class="hud">
    <div class="hud-round">Rodada <span id="g-round">1</span> / 5</div>
    <div class="hud-timer" id="g-timer">60</div>
  </div>
  <div class="game-layout">
    <!-- Left: letter + categories + stop -->
    <div>
      <div class="letter-stage">
        <div class="letter-ring"><span class="letter-char" id="g-letter">A</span></div>
      </div>
      <div id="g-alert" class="stop-alert" style="display:none;"></div>
      <div class="panel" style="padding:1.5rem;">
        <div class="cat-grid" id="g-cats"></div>
      </div>
      <div class="stop-stage">
        <button class="stop-btn" id="stop-btn" onclick="pressStop()">
          <span class="si">‚úã</span><span>STOP</span>
        </button>
      </div>
    </div>
    <!-- Right: chat -->
    <div>
      <div class="panel" style="padding:0;overflow:hidden;display:flex;flex-direction:column;min-height:520px;">
        <div class="ptag">Chat</div>
        <div style="margin-top:1.5rem;display:flex;flex-direction:column;flex:1;">
          <div class="chat-tabs">
            <button class="chat-tab active" id="tab-text" onclick="switchTab('text')">üí¨ Texto</button>
            <button class="chat-tab" id="tab-voice" onclick="switchTab('voice')">üéôÔ∏è Voz</button>
          </div>

          <!-- TEXT CHAT -->
          <div id="chat-text" style="display:flex;flex-direction:column;flex:1;">
            <div class="chat-msgs" id="chat-msgs"></div>
            <div class="chat-input-row">
              <input type="text" id="chat-inp" placeholder="mensagem..." maxlength="120" autocomplete="off" onkeydown="if(event.key==='Enter')sendChat()">
              <button class="btn btn-cyan btn-icon" onclick="sendChat()">‚ñ∂</button>
            </div>
          </div>

          <!-- VOICE CHAT -->
          <div id="chat-voice" style="display:none;flex-direction:column;flex:1;align-items:center;justify-content:center;gap:1rem;padding:1.5rem;">
            <div class="voice-status" id="voice-status">// Chat de Voz ao Vivo</div>
            <div id="voice-peers" style="display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;min-height:2rem;"></div>
            <button class="mic-btn" id="mic-btn" onclick="toggleVoice()">üéôÔ∏è</button>
            <div class="voice-transcript" id="voice-label" style="color:var(--dim);font-size:.75rem;text-align:center;">Clique para entrar no canal de voz</div>
            <audio id="remote-audio" autoplay style="display:none"></audio>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ñà‚ñà RESULTS ‚ñà‚ñà -->
<div id="screen-results" class="screen">
  <div class="r-header">
    <div class="r-letter-ring" id="r-letter">A</div>
    <div class="neon-title np" style="font-size:1.8rem;">RODADA <span id="r-round">1</span> ‚Äî RESULTADOS</div>
  </div>
  <div class="scoreboard" id="r-board"></div>
  <div class="panel" id="r-content" style="padding:1.5rem;"></div>
  <div class="mt2 center">
    <button class="btn btn-green" id="btn-next" onclick="nextRound()" style="max-width:380px;margin:0 auto .75rem;">Pr√≥xima Rodada ‚Üí</button>
    <div id="r-wait" class="empty-state" style="display:none;">Aguardando host...</div>
  </div>
</div>

<!-- ‚ñà‚ñà FINAL ‚ñà‚ñà -->
<div id="screen-final" class="screen">
  <div class="trophy-wrap">üèÜ</div>
  <div class="winner-line" id="f-winner"></div>
  <div class="panel" style="max-width:580px;margin:0 auto 1.5rem;padding:1.75rem;">
    <div class="ptag yw">Ranking Final</div>
    <div id="f-ranking" style="margin-top:.75rem;display:flex;flex-direction:column;gap:.7rem;"></div>
  </div>
  <div class="two-col" style="max-width:480px;margin:0 auto;">
    <button class="btn btn-cyan" onclick="playAgain()">‚Ü∫ Revanche</button>
    <button class="btn btn-ghost" onclick="goHome()">‚åÇ In√≠cio</button>
  </div>
</div>

</div><!-- #app -->
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp }  from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAnalytics }   from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
import { getDatabase, ref, set, get, update, onValue, push, remove, serverTimestamp }
                          from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const app = initializeApp({
  apiKey:'AIzaSyBdxd54oFM3eWH1duC5BTdJzjGGRDLMq-Q',
  authDomain:'mary-cb817.firebaseapp.com',
  databaseURL:'https://mary-cb817-default-rtdb.firebaseio.com',
  projectId:'mary-cb817',
  storageBucket:'mary-cb817.firebasestorage.app',
  messagingSenderId:'887348832569',
  appId:'1:887348832569:web:c6d9c32a1a1c402b8960e8',
  measurementId:'G-86HWEH554E'
});
getAnalytics(app);
const db = getDatabase(app);

// ID √∫nico por aba via sessionStorage
const pid = sessionStorage.getItem('sid') || ('p_'+Date.now()+'_'+Math.random().toString(36).substr(2,9));
sessionStorage.setItem('sid',pid);

const gs = {
  pid, name: localStorage.getItem('pname')||'',
  roomId:null, roomCode:null, isHost:false,
  answers:{}, timer:null, unsub:null, chatUnsub:null, round:-1, saved:false, calcPending:false,
  micOn:false, recognition:null,
};

const CATS = [
  {id:'person',label:'Nome de Pessoa'},
  {id:'animal',label:'Animal'},
  {id:'fruit',label:'Fruta'},
  {id:'city',label:'Cidade'},
  {id:'object',label:'Objeto'},
  {id:'profession',label:'Profiss√£o'},
  {id:'color',label:'Cor'},
  {id:'brand',label:'Marca'},
];

const $ = id => document.getElementById(id);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const rnd6 = () => [...Array(6)].map(()=>'ABCDEFGHJKLMNPQRSTUVWXYZ'[Math.floor(Math.random()*24)]).join('');
const rndL = () => 'ABCDEFGHIJLMNOPRSTV'[Math.floor(Math.random()*19)];

let toastTm;
const toast = msg => {
  const el=$('toast'); el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastTm);
  toastTm=setTimeout(()=>el.classList.remove('show'),3000);
};

const showScreen = id => {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
};

// ‚îÄ‚îÄ WORD VALIDATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Cache para n√£o fazer requests repetidas
const wordCache = {};
const validateTimers = {};

async function checkWord(word) {
  if (!word || word.trim().length < 2) return null;
  const w = word.trim().toLowerCase();
  if (wordCache[w] !== undefined) return wordCache[w];

  try {
    // API de dicion√°rio PT-BR via dictionaryapi.dev
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/pt/${encodeURIComponent(w)}`);
    const valid = res.ok;
    wordCache[w] = valid;
    return valid;
  } catch {
    // fallback: considera v√°lida se tiver erro de rede
    return null;
  }
}

function setValStatus(catId, status) {
  // status: null | 'checking' | 'valid' | 'invalid'
  const bar = document.getElementById(`vs-${catId}`);
  const dot = document.getElementById(`vd-${catId}`);
  if (!bar || !dot) return;
  bar.className = 'val-status' + (status ? ' '+status : '');
  dot.className = 'val-dot' + (status ? ' show '+status : '');
}

function scheduleValidation(catId, value) {
  clearTimeout(validateTimers[catId]);
  if (!value || value.trim().length < 2) { setValStatus(catId, null); return; }

  setValStatus(catId, 'checking');
  validateTimers[catId] = setTimeout(async () => {
    const result = await checkWord(value.trim());
    if (result === null) { setValStatus(catId, null); return; }
    setValStatus(catId, result ? 'valid' : 'invalid');
  }, 700);
}

// ‚îÄ‚îÄ CRIAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.createRoom = async () => {
  const name = $('inp-name').value.trim();
  if (!name) { toast('// ERRO: INSIRA SEU APELIDO'); return; }
  const code=rnd6(), roomRef=push(ref(db,'rooms')), roomId=roomRef.key;
  gs.roomId=roomId; gs.roomCode=code; gs.name=name; gs.isHost=true;
  localStorage.setItem('pname',name);
  await set(roomRef,{
    code, createdAt:Date.now(),
    players:{[pid]:{name,score:0,isHost:true,joinedAt:Date.now()}},
    gameState:{status:'waiting',letter:null,round:0,timer:60,stopped:false,stoppedBy:null},
    answers:{_:0}, chat:{_:0},
  });
  toast('// SALA CRIADA: '+code);
  showScreen('lobby');
  listenRoom(roomId);
};

// ‚îÄ‚îÄ ENTRAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.joinRoom = async () => {
  const name=$('inp-name').value.trim();
  const code=$('inp-code').value.trim().toUpperCase();
  if (!name) { toast('// ERRO: INSIRA SEU APELIDO'); return; }
  if (!code) { toast('// ERRO: INSIRA O C√ìDIGO'); return; }
  const snap=await get(ref(db,'rooms'));
  const rooms=snap.val()||{};
  let foundId=null;
  Object.keys(rooms).forEach(id=>{ if(rooms[id].code===code) foundId=id; });
  if (!foundId)                             { toast('// SALA N√ÉO ENCONTRADA'); return; }
  if (Object.keys(rooms[foundId].players||{}).length>=6) { toast('// SALA CHEIA'); return; }
  if (rooms[foundId].gameState.status!=='waiting')       { toast('// PARTIDA EM ANDAMENTO'); return; }
  gs.roomId=foundId; gs.roomCode=code; gs.name=name; gs.isHost=false;
  localStorage.setItem('pname',name);
  await update(ref(db,`rooms/${foundId}/players/${pid}`),{name,score:0,isHost:false,joinedAt:Date.now()});
  toast('// CONECTADO');
  showScreen('lobby');
  listenRoom(foundId);
};

// ‚îÄ‚îÄ LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenRoom(roomId) {
  if (gs.unsub){ gs.unsub(); gs.unsub=null; }
  gs.unsub=onValue(ref(db,`rooms/${roomId}`),snap=>{
    const data=snap.val(); if(!data) return;
    renderLobby(data);
    const s=data.gameState?.status;
    if      (s==='playing'){ showScreen('game');    renderGame(data); }
    else if (s==='results'){ showScreen('results'); renderResults(data); }
    else if (s==='final')  { showScreen('final');   renderFinal(data); }
    else                   { showScreen('lobby'); }
  });
  // Chat listener separado
  if (gs.chatUnsub){ gs.chatUnsub(); gs.chatUnsub=null; }
  gs.chatUnsub=onValue(ref(db,`rooms/${roomId}/chat`),snap=>{
    const data=snap.val()||{};
    renderChatMsgs(data);
  });
}

// ‚îÄ‚îÄ CHAT TEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchTab = tab => {
  $('tab-text').classList.toggle('active', tab==='text');
  $('tab-voice').classList.toggle('active', tab==='voice');
  $('chat-text').style.display = tab==='text' ? 'flex' : 'none';
  $('chat-voice').style.display = tab==='voice' ? 'flex' : 'none';
};

window.sendChat = async () => {
  const inp=$('chat-inp');
  const txt=inp.value.trim();
  if (!txt || !gs.roomId) return;
  inp.value='';
  const msgRef=push(ref(db,`rooms/${gs.roomId}/chat`));
  await set(msgRef,{
    pid, name:gs.name,
    text:txt,
    ts:Date.now()
  });
};

function renderChatMsgs(data){
  const msgs=$('chat-msgs');
  if(!msgs) return;

  // collect non-placeholder
  const entries=Object.entries(data)
    .filter(([k])=>k!=='_')
    .map(([,v])=>v)
    .sort((a,b)=>(a.ts||0)-(b.ts||0));

  const buildMsgEl = (v) => {
    const isMe = v.pid===pid;
    const isSys = v.sys;
    const div=document.createElement('div');
    div.className='chat-msg '+(isSys?'sys':isMe?'me':'them');
    if(!isSys){
      div.innerHTML=`<div class="msg-author ${isMe?'me':'them'}">${esc(v.name)}</div><div class="msg-text">${esc(v.text)}</div>`;
    } else {
      div.textContent=v.text;
    }
    return div;
  };

  msgs.innerHTML='';
  entries.forEach(v=>{
    msgs.appendChild(buildMsgEl(v));
  });
  msgs.scrollTop=msgs.scrollHeight;
}

// ‚îÄ‚îÄ VOICE CHAT (WebRTC ao vivo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let voiceActive = false;
let localStream = null;
const peerConnections = {}; // pid -> RTCPeerConnection
const iceCandidateQueue = {}; // pid -> []

const RTC_CONFIG = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

window.toggleVoice = async () => {
  if (voiceActive) {
    await leaveVoice();
  } else {
    await joinVoice();
  }
};

async function joinVoice() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  } catch(e) {
    toast('// ERRO: PERMISS√ÉO DE MICROFONE NEGADA');
    return;
  }
  voiceActive = true;
  $('mic-btn').classList.add('active');
  $('voice-status').className = 'voice-status listening';
  $('voice-status').textContent = '// Conectado ao canal de voz';
  $('voice-label').textContent = 'Clique para sair do canal de voz';

  // Signal presence
  await set(ref(db, `rooms/${gs.roomId}/voice/${pid}`), { name: gs.name, ts: Date.now() });

  // Listen for other voice participants
  onValue(ref(db, `rooms/${gs.roomId}/voice`), async snap => {
    const all = snap.val() || {};
    // Connect to new peers
    for (const remotePid of Object.keys(all)) {
      if (remotePid === pid || peerConnections[remotePid]) continue;
      await createOffer(remotePid);
    }
    // Clean up disconnected peers
    for (const remotePid of Object.keys(peerConnections)) {
      if (!all[remotePid]) {
        closePeer(remotePid);
      }
    }
    renderVoicePeers(all);
  });

  // Listen for signaling messages directed to us
  onValue(ref(db, `rooms/${gs.roomId}/signal/${pid}`), async snap => {
    const msgs = snap.val() || {};
    for (const [key, msg] of Object.entries(msgs)) {
      if (!msg) continue;
      if (msg.type === 'offer') {
        await handleOffer(msg.from, msg.sdp);
      } else if (msg.type === 'answer') {
        await handleAnswer(msg.from, msg.sdp);
      } else if (msg.type === 'ice') {
        await handleIce(msg.from, msg.candidate);
      }
      // Remove processed message
      await remove(ref(db, `rooms/${gs.roomId}/signal/${pid}/${key}`));
    }
  });
}

async function leaveVoice() {
  voiceActive = false;
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  Object.keys(peerConnections).forEach(p => closePeer(p));
  $('mic-btn').classList.remove('active');
  $('voice-status').className = 'voice-status';
  $('voice-status').textContent = '// Chat de Voz ao Vivo';
  $('voice-label').textContent = 'Clique para entrar no canal de voz';
  $('voice-peers').innerHTML = '';
  if (gs.roomId) {
    await remove(ref(db, `rooms/${gs.roomId}/voice/${pid}`)).catch(()=>{});
    await remove(ref(db, `rooms/${gs.roomId}/signal/${pid}`)).catch(()=>{});
  }
}

function closePeer(remotePid) {
  if (peerConnections[remotePid]) {
    peerConnections[remotePid].close();
    delete peerConnections[remotePid];
  }
  delete iceCandidateQueue[remotePid];
}

function renderVoicePeers(all) {
  const cont = $('voice-peers');
  if (!cont) return;
  cont.innerHTML = '';
  Object.entries(all).forEach(([id, info]) => {
    const chip = document.createElement('div');
    chip.style.cssText = 'font-family:Orbitron,monospace;font-size:.6rem;padding:.2rem .6rem;border:1px solid rgba(57,255,20,.4);color:var(--green);border-radius:2px;';
    chip.textContent = (id === pid ? 'üéôÔ∏è ' : 'üîä ') + esc(info.name || id);
    cont.appendChild(chip);
  });
}

function createPeer(remotePid) {
  const pc = new RTCPeerConnection(RTC_CONFIG);
  peerConnections[remotePid] = pc;
  iceCandidateQueue[remotePid] = [];

  if (localStream) {
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  }

  pc.ontrack = e => {
    const audio = $('remote-audio') || document.createElement('audio');
    audio.autoplay = true;
    audio.srcObject = e.streams[0];
  };

  pc.onicecandidate = async e => {
    if (!e.candidate) return;
    const msgRef = push(ref(db, `rooms/${gs.roomId}/signal/${remotePid}`));
    await set(msgRef, { type: 'ice', from: pid, candidate: e.candidate.toJSON() });
  };

  return pc;
}

async function createOffer(remotePid) {
  const pc = createPeer(remotePid);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  const msgRef = push(ref(db, `rooms/${gs.roomId}/signal/${remotePid}`));
  await set(msgRef, { type: 'offer', from: pid, sdp: pc.localDescription.sdp });
}

async function handleOffer(remotePid, sdp) {
  if (peerConnections[remotePid]) return;
  const pc = createPeer(remotePid);
  await pc.setRemoteDescription({ type: 'offer', sdp });
  // flush queued ICE
  for (const c of (iceCandidateQueue[remotePid] || [])) {
    await pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
  }
  iceCandidateQueue[remotePid] = [];
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  const msgRef = push(ref(db, `rooms/${gs.roomId}/signal/${remotePid}`));
  await set(msgRef, { type: 'answer', from: pid, sdp: pc.localDescription.sdp });
}

async function handleAnswer(remotePid, sdp) {
  const pc = peerConnections[remotePid];
  if (!pc) return;
  await pc.setRemoteDescription({ type: 'answer', sdp });
  for (const c of (iceCandidateQueue[remotePid] || [])) {
    await pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
  }
  iceCandidateQueue[remotePid] = [];
}

async function handleIce(remotePid, candidate) {
  const pc = peerConnections[remotePid];
  if (!pc || !pc.remoteDescription) {
    if (!iceCandidateQueue[remotePid]) iceCandidateQueue[remotePid] = [];
    iceCandidateQueue[remotePid].push(candidate);
    return;
  }
  await pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(()=>{});
}

// Keep stopMic for leaveRoom cleanup
function stopMic(){ leaveVoice().catch(()=>{}); }

// ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLobby(data){
  $('lob-code').textContent=data.code||'------';
  const players=data.players||{};
  const count=Object.keys(players).length;
  $('lob-count').textContent=count===0?'// Aguardando conex√µes...':`// ${count} jogador${count!==1?'es':''} conectado${count!==1?'s':''}`;
  $('lob-count-n').textContent=`(${count})`;
  const list=$('lob-players');
  list.innerHTML='';
  if(count===0){
    list.innerHTML='<div class="empty-state">Aguardando conex√µes...</div>';
  } else {
    Object.entries(players).forEach(([id,p])=>{
      const me=id===pid;
      const row=document.createElement('div');
      row.className='prow'+(me?' me':p.isHost?' host':'');
      row.innerHTML=`
        <div class="pdot ${me?'me':p.isHost?'host':''}"></div>
        <div class="pname">${esc(p.name)}${me?'<span class="ptag2">[VOC√ä]</span>':''}${p.isHost?'<span class="ptag2 ht">[HOST]</span>':''}</div>
        <div class="ppts">${p.score||0}</div>`;
      list.appendChild(row);
    });
  }
  gs.isHost=!!players[pid]?.isHost;
  const btn=$('btn-start');
  if(gs.isHost){
    btn.style.display='flex';
    btn.disabled=count<2;
    btn.textContent=count<2?'// Aguarde mais jogadores...':`‚ñ∂ Iniciar (${count} jogadores)`;
  } else {
    btn.style.display='none';
  }
}

window.startGame=async()=>{
  await update(ref(db,`rooms/${gs.roomId}/gameState`),{
    status:'playing',letter:rndL(),round:1,timer:60,stopped:false,stoppedBy:null
  });
  // System message
  const msgRef=push(ref(db,`rooms/${gs.roomId}/chat`));
  await set(msgRef,{sys:true,text:'// PARTIDA INICIADA! BOA SORTE A TODOS.',ts:Date.now()});
};

// ‚îÄ‚îÄ JOGO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGame(data){
  const gst=data.gameState;
  $('g-round').textContent=gst.round;
  const t=$('g-timer');
  t.textContent=gst.timer;
  t.className='hud-timer'+(gst.timer<=10?' danger':gst.timer<=25?' warn':'');

  if(gst.round!==gs.round){
    gs.round=gst.round; gs.answers={}; gs.saved=false; gs.calcPending=false;
    const lc=$('g-letter');
    lc.textContent=gst.letter;
    lc.style.animation='none';
    requestAnimationFrame(()=>{ lc.style.animation=''; });

    const wrap=$('g-cats');
    wrap.innerHTML='';
    CATS.forEach(cat=>{
      const div=document.createElement('div');
      div.className='cat-item';
      div.innerHTML=`
        <div class="cat-label">
          ‚óà ${cat.label}
          <span class="val-dot" id="vd-${cat.id}"></span>
        </div>
        <input class="cat-input" type="text" id="ci-${cat.id}" autocomplete="off">
        <div class="val-status" id="vs-${cat.id}"></div>`;
      wrap.appendChild(div);
      const inp=document.getElementById(`ci-${cat.id}`);
      inp.addEventListener('input',e=>{
        gs.answers[cat.id]=e.target.value;
        scheduleValidation(cat.id, e.target.value);
      });
    });
  }

  const alert=$('g-alert');
  if(gst.stopped&&gst.stoppedBy){
    const who=data.players?.[gst.stoppedBy]?.name||'Algu√©m';
    alert.textContent=`// ${esc(who).toUpperCase()} APERTOU STOP ‚Äî SALVANDO...`;
    alert.style.display='block';
  } else { alert.style.display='none'; }

  CATS.forEach(c=>{
    const inp=document.getElementById(`ci-${c.id}`);
    if(inp) inp.disabled=gst.stopped;
  });
  $('stop-btn').disabled=gst.stopped;

  if(gst.stopped&&!gs.saved){
    gs.saved=true;
    set(ref(db,`rooms/${gs.roomId}/answers/${pid}/${gst.round}`),gs.answers||{}).catch(()=>{});
  }

  gs.isHost=!!data.players?.[pid]?.isHost;
  if(gs.isHost&&!gst.stopped&&!gs.timer){
    gs.timer=setInterval(async()=>{
      const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
      const g=s.val();
      if(!g||g.status!=='playing'){ clearInterval(gs.timer);gs.timer=null;return; }
      if(g.stopped){ clearInterval(gs.timer);gs.timer=null;return; }
      if(g.timer>1){
        await update(ref(db,`rooms/${gs.roomId}/gameState`),{timer:g.timer-1});
      } else {
        clearInterval(gs.timer);gs.timer=null;
        await update(ref(db,`rooms/${gs.roomId}/gameState`),{stopped:true,stoppedBy:null,timer:0});
        setTimeout(()=>calcResults(g.round),2500);
      }
    },1000);
  }
  // Host detects stop from any player and triggers calcResults
  if(gst.stopped&&gs.timer){ clearInterval(gs.timer);gs.timer=null; }
  if(gst.stopped&&gs.isHost&&!gs.calcPending){
    gs.calcPending=true;
    setTimeout(()=>{ gs.calcPending=false; calcResults(gst.round); },2500);
  }
}

window.pressStop=async()=>{
  const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
  if(s.val()?.stopped) return;
  const round=s.val()?.round||1;
  gs.saved=true;
  await set(ref(db,`rooms/${gs.roomId}/answers/${pid}/${round}`),gs.answers||{});
  await update(ref(db,`rooms/${gs.roomId}/gameState`),{stopped:true,stoppedBy:pid,timer:0});
  if(gs.timer){ clearInterval(gs.timer);gs.timer=null; }
  // Chat system message
  const msgRef=push(ref(db,`rooms/${gs.roomId}/chat`));
  await set(msgRef,{sys:true,text:`// ${gs.name.toUpperCase()} APERTOU STOP!`,ts:Date.now()});
  if(gs.isHost) setTimeout(()=>calcResults(round),2500);
};

async function calcResults(round){
  const snap=await get(ref(db,`rooms/${gs.roomId}`));
  const data=snap.val();
  const players=data.players||{}, answers=data.answers||{};
  const letter=data.gameState.letter, pts={};
  CATS.forEach(cat=>{
    const valid={};
    Object.keys(players).forEach(id=>{
      const ans=(answers[id]?.[round]?.[cat.id]||'').trim();
      if(ans&&ans.charAt(0).toUpperCase()===letter.toUpperCase()) valid[id]=ans.toLowerCase();
    });
    Object.keys(players).forEach(id=>{
      if(!pts[id]) pts[id]=0;
      if(valid[id]===undefined) return;
      const rep=Object.keys(valid).some(o=>o!==id&&valid[o]===valid[id]);
      pts[id]+=rep?5:10;
    });
  });
  const upd={};
  Object.keys(players).forEach(id=>{
    upd[`players/${id}/score`]=(players[id].score||0)+(pts[id]||0);
  });
  upd['gameState/status']='results';
  await update(ref(db,`rooms/${gs.roomId}`),upd);
}

// ‚îÄ‚îÄ RESULTADOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults(data){
  const gst=data.gameState, players=data.players||{};
  const answers=data.answers||{}, letter=gst.letter, round=gst.round;
  $('r-round').textContent=round;
  $('r-letter').textContent=letter;

  const board=$('r-board');
  board.innerHTML='';
  Object.entries(players).sort((a,b)=>(b[1].score||0)-(a[1].score||0)).forEach(([id,p])=>{
    const chip=document.createElement('div');
    chip.className='schip '+(id===pid?'sc-me':'sc-other');
    chip.innerHTML=`${id===pid?'[VOC√ä] ':''}${esc(p.name)}: ${p.score||0} PTS`;
    board.appendChild(chip);
  });

  const content=$('r-content'); content.innerHTML='';
  CATS.forEach(cat=>{
    const valid={};
    Object.keys(players).forEach(id=>{
      const ans=(answers[id]?.[round]?.[cat.id]||'').trim();
      if(ans&&ans.charAt(0).toUpperCase()===letter.toUpperCase()) valid[id]=ans.toLowerCase();
    });
    const sec=document.createElement('div');
    sec.className='cat-result';
    sec.innerHTML=`<div class="cr-title">${cat.label}</div>`;
    const rows=document.createElement('div');
    rows.className='ans-rows';

    Object.entries(players).forEach(([id,player])=>{
      const raw=(answers[id]?.[round]?.[cat.id]||'').trim();
      let rowCls='p0', ptsCls='r', ptsLabel='‚úó 0';
      if(valid[id]!==undefined){
        const rep=Object.keys(valid).some(o=>o!==id&&valid[o]===valid[id]);
        if(rep){ rowCls='p5'; ptsCls='y'; ptsLabel='‚ñ≥ +5'; }
        else   { rowCls='p10'; ptsCls='g'; ptsLabel='‚úì +10'; }
      }
      // Check cache for word validation badge
      const wCached = raw ? wordCache[raw.toLowerCase()] : undefined;
      const vBadge = wCached===true ? '<span class="an-vbadge ok">V√ÅLIDA</span>'
                   : wCached===false? '<span class="an-vbadge no">INV√ÅLIDA</span>'
                   : '';
      const row=document.createElement('div');
      row.className=`ans-row ${rowCls}`;
      row.innerHTML=`
        <div class="an-player ${id===pid?'me':'them'}">${esc(player.name)}${id===pid?' [voc√™]':''}</div>
        <div class="an-word${!raw?' empty':''}">${raw?esc(raw):'vazio'}</div>
        ${vBadge}
        <div class="an-pts ${ptsCls}">${ptsLabel}</div>`;
      rows.appendChild(row);
    });
    sec.appendChild(rows); content.appendChild(sec);
  });

  gs.isHost=!!players[pid]?.isHost;
  const nb=$('btn-next'), wm=$('r-wait');
  if(gs.isHost){
    nb.style.display='flex'; wm.style.display='none';
    nb.textContent=round>=5?'‚ñ∂ Ver Ranking Final':`‚ñ∂ Pr√≥xima Rodada (${round+1}/5)`;
  } else {
    nb.style.display='none'; wm.style.display='block';
  }
}

window.nextRound=async()=>{
  const s=await get(ref(db,`rooms/${gs.roomId}/gameState`));
  const g=s.val(); gs.round=-1;
  if(g.round>=5){
    await update(ref(db,`rooms/${gs.roomId}/gameState`),{status:'final'});
  } else {
    const letter=rndL();
    const msgRef=push(ref(db,`rooms/${gs.roomId}/chat`));
    await set(msgRef,{sys:true,text:`// RODADA ${g.round+1} ‚Äî LETRA: ${letter}`,ts:Date.now()});
    await update(ref(db,`rooms/${gs.roomId}/gameState`),{
      status:'playing',letter,round:g.round+1,timer:60,stopped:false,stoppedBy:null
    });
  }
};

// ‚îÄ‚îÄ FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFinal(data){
  const players=data.players||{};
  const sorted=Object.entries(players).map(([id,p])=>({id,...p})).sort((a,b)=>(b.score||0)-(a.score||0));
  const winner=sorted[0];
  $('f-winner').textContent=winner?.id===pid?'// PARAB√âNS ‚Äî VOC√ä VENCEU!':`// VENCEDOR: ${winner?.name||'?'}`;
  const list=$('f-ranking'); list.innerHTML='';
  const cls={0:'rk1',1:'rk2',2:'rk3'};
  const medals=['ü•á','ü•à','ü•â','‚óà','‚óà','‚óà'];
  sorted.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className=`rank-row ${cls[i]||'rkn'}`;
    div.innerHTML=`<div class="rank-medal">${medals[i]}</div><div class="rank-name">${esc(p.name)}${p.id===pid?'<span class="rank-you">[VOC√ä]</span>':''}</div><div class="rank-pts">${p.score||0} PTS</div>`;
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.copyCode=()=>{ navigator.clipboard.writeText(gs.roomCode||'').catch(()=>{}); toast('// C√ìDIGO COPIADO: '+gs.roomCode); };

window.leaveRoom=async()=>{
  if(gs.timer){ clearInterval(gs.timer);gs.timer=null; }
  if(gs.unsub){ gs.unsub();gs.unsub=null; }
  if(gs.chatUnsub){ gs.chatUnsub();gs.chatUnsub=null; }
  await leaveVoice().catch(()=>{});
  if(gs.roomId){
    await remove(ref(db,`rooms/${gs.roomId}/players/${pid}`)).catch(()=>{});
    gs.roomId=null;gs.roomCode=null;
  }
  gs.round=-1; showScreen('home');
};

window.playAgain=async()=>{
  const snap=await get(ref(db,`rooms/${gs.roomId}`));
  const data=snap.val(); const upd={};
  Object.keys(data.players||{}).forEach(id=>{ upd[`players/${id}/score`]=0; });
  upd['gameState']={status:'waiting',letter:null,round:0,timer:60,stopped:false,stoppedBy:null};
  upd['answers']={_:0};
  upd['chat']={_:0};
  await update(ref(db,`rooms/${gs.roomId}`),upd);
  gs.round=-1; showScreen('lobby');
};

window.goHome=()=>leaveRoom();

if(gs.name) $('inp-name').value=gs.name;
</script>
</body>
</html>
